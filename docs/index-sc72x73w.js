var n;((J)=>{J.EARTH="Earth";J.MOON="Moon";J.MARS="Mars";J.SPACE_STATION="Space Station";J.TRAVELING="Traveling"})(n||={});class d{type;name;uuid;constructor(_,X,$){this.type=_,this.name=X,this.uuid=$}static fromData(_){return new d(_.type,_.name,_.uuid)}toData(){return{type:this.type,name:this.name,uuid:this.uuid}}getId(){return this.uuid}getType(){return this.type}}function a(_){switch(_){case"Mars":return 5;case"Moon":return 4;case"Space Station":return 0.5;case"Traveling":return 0;default:return 1}}var P={game:{minutesPerSol:0.5,autoSaveIntervalMs:60000},infrastructure:{maxLevel:499,rocketLab:{workersBase:1,workersPerLevelDivisor:10,workersPerLevelMultiplier:2,benefitLevelDivisor:10,benefitBaseValue:1},storeroom:{baseCapacity:200,capacityScalingFactor:1.2,workersBase:1,workersPerLevelDivisor:10,workersPerLevelMultiplier:2}},production:{workersPerProductionUnitDivisor:10},goods:{defaultBuyPrice:100,defaultSellPrice:50,defaultProductionPerSol:1}};var q0;((K)=>{K[K.EVERYWHERE=0]="EVERYWHERE";K[K.EARTH_ONLY=1]="EARTH_ONLY";K[K.MARS_ONLY=2]="MARS_ONLY";K[K.MOON_ONLY=3]="MOON_ONLY";K[K.SPACE_ONLY=4]="SPACE_ONLY";K[K.LOW_GRAVITY_ONLY=5]="LOW_GRAVITY_ONLY"})(q0||={});((B_)=>{function _(X,$){switch(X){case 0:return!0;case 1:return $==="Earth";case 2:return $==="Mars";case 3:return $==="Moon";case 4:return $==="Space Station";case 5:return $==="Mars"||$==="Space Station"||$==="Moon";default:return!1}}B_.isValidForLocation=_})(q0||={});class x0{id;name;category;productionRequirement;baseProductionPerSol=1;marketBuyPrice;marketSellPrice;constructor(_,X,$,j={}){this.id=_,this.name=X,this.category=$,this.baseProductionPerSol=j.baseProductionPerSol??P.goods.defaultProductionPerSol,this.productionRequirement=j.productionRequirement??0,this.marketBuyPrice=j.marketBuyPrice??P.goods.defaultBuyPrice,this.marketSellPrice=j.marketSellPrice??P.goods.defaultSellPrice}static fromData(_){return new x0(_.id,_.name,_.category,{baseProductionPerSol:_.baseProductionPerSol,productionRequirement:_.productionRequirement,marketBuyPrice:_.marketBuyPrice,marketSellPrice:_.marketSellPrice})}toData(){return{id:this.id,name:this.name,category:this.category,baseProductionPerSol:this.baseProductionPerSol,productionRequirement:this.productionRequirement,marketBuyPrice:this.marketBuyPrice,marketSellPrice:this.marketSellPrice}}getId(){return this.id}}class f{good;quantity;constructor(_,X){this.good=_,this.quantity=X}toData(){return{good:this.good.getId(),quantity:this.quantity}}static fromData(_,X){let $=X.get(_.good);if(!$)throw Error(`Unknown good id: ${_.good}`);return new f($,_.quantity)}}class E0{level;MAX_LEVEL=999;constructor(_=1){this.level=Math.min(_,this.MAX_LEVEL)}getLevel(){return this.level}setLevel(_){this.level=Math.min(_,this.MAX_LEVEL)}isMaxLevel(){return this.level>=this.MAX_LEVEL}incrementLevel(){if(!this.isMaxLevel())this.level++,this.onUpgrade()}getUpgradeCost(){return Math.floor(50*Math.pow(1.2,this.level-1))}}var g=[{from:"Earth",to:"Mars",travelTime:6,fuelCost:1e5},{from:"Earth",to:"Moon",travelTime:2,fuelCost:30000},{from:"Moon",to:"Mars",travelTime:5,fuelCost:50000},{from:"Space Station",to:"Mars",travelTime:5,fuelCost:90000},{from:"Space Station",to:"Moon",travelTime:1,fuelCost:20000},{from:"Earth",to:"Space Station",travelTime:0.5,fuelCost:500}];function U0(_,X){let $=g.find((j)=>j.from===_&&j.to===X);if(!$)$=g.find((j)=>j.from===X&&j.to===_);return $}class Q0 extends E0{items;baseCapacity;scaleFactor=1.2;constructor(_,X,$=1){super($);this.items=_,this.baseCapacity=X}getItemPositions(){return this.items}setItems(_){this.items=_}getTotalQuantity(){return Math.floor(this.items.reduce((_,X)=>_+X.quantity,0))}getCapacity(_){return Math.floor(this.baseCapacity*Math.pow(this.scaleFactor,(_??this.getLevel())+1))}addItemPosition(_){if(this.getTotalQuantity()+_.quantity<=this.getCapacity()){let X=this.items.find(($)=>$.good.getId()===_.good.getId());if(X)X.quantity+=_.quantity;else this.items.push(_);return!0}else return!1}removeItemPosition(_){this.items=this.items.filter((X)=>X.good.getId()!==_)}reduceItemQuantity(_,X){let $=this.items.find((j)=>j.good.getId()===_);if($){if($.quantity-=X,$.quantity<0)return $.quantity+=X,!1;return!0}else return!1}setCapacity(_){this.baseCapacity=_}toStorageData(){return{items:this.items.map((_)=>_.toData()),level:this.getLevel()}}}class r extends Q0{id;name;estimatedTravelTime;initialTravelTime;locationId;destinationId;sellRoute=!1;sellRouteOriginId=null;sellRouteState="idle";constructor(_,X,$,j,Y=1){super([],100,Y);this.id=_,this.name=X,this.estimatedTravelTime=$,this.initialTravelTime=0,this.locationId=j,this.destinationId=null}getId(){return this.id}onUpgrade(){}getProperties(){return[{name:"Travel time",value:this.estimatedTravelTime,increase:5},{name:"Capacity",value:this.getCapacity(),increase:this.getCapacity(this.getLevel()+1)-this.getCapacity()},{name:"Fuel Efficiency",value:100,increase:5}]}startTravel(_){if(this.destinationId)return!1;if(this.locationId.getId()===_.getId())return!1;let X=U0(this.locationId.getType(),_.getType());if(X)return this.destinationId=_,this.estimatedTravelTime=X.travelTime*P.game.minutesPerSol,this.initialTravelTime=this.estimatedTravelTime,!0;return!1}getLocation(){return this.locationId}getDestination(){return this.destinationId}completeTravel(){if(this.destinationId)this.locationId=this.destinationId,this.destinationId=null,this.estimatedTravelTime=0,this.initialTravelTime=0}toData(){return{id:this.id,name:this.name,estimatedTravelTime:this.estimatedTravelTime,initialTravelTime:this.initialTravelTime,location:this.locationId.toData(),destination:this.destinationId?this.destinationId.toData():null,storage:this.toStorageData(),sellRoute:this.sellRoute,sellRouteOriginId:this.sellRouteOriginId,sellRouteState:this.sellRouteState}}static fromData(_,X,$){let j=X.get(_.location.uuid)??d.fromData(_.location),Y=new r(_.id,_.name,_.estimatedTravelTime,j,_.storage?.level??1);Y.initialTravelTime=_.initialTravelTime??0;let J=(_.storage?.items??[]).map((K)=>f.fromData(K,$));if(Y.setItems(J),_.destination){let K=X.get(_.destination.uuid)??d.fromData(_.destination);Y.destinationId=K}return Y.sellRoute=_.sellRoute??!1,Y.sellRouteOriginId=_.sellRouteOriginId??null,Y.sellRouteState=_.sellRouteState??"idle",Y}}var __=[{id:1,name:"Food",category:"Food",baseProductionPerSol:1.5,marketBuyPrice:50,marketSellPrice:40},{id:2,name:"Water",category:"Food",baseProductionPerSol:1.2,marketBuyPrice:40,marketSellPrice:25},{id:3,name:"Fuel",category:"Fuel",baseProductionPerSol:1,marketBuyPrice:100,marketSellPrice:70},{id:4,name:"Computer",category:"Electronics",baseProductionPerSol:0.8,productionRequirement:1,marketBuyPrice:500,marketSellPrice:350},{id:5,name:"Circuit Board",category:"Electronics",baseProductionPerSol:0.6,productionRequirement:1,marketBuyPrice:300,marketSellPrice:200},{id:6,name:"Solar Panel",category:"Electronics",baseProductionPerSol:1,productionRequirement:1,marketBuyPrice:400,marketSellPrice:280},{id:7,name:"O2",category:"Fuel",baseProductionPerSol:1.2,marketBuyPrice:80,marketSellPrice:50}],L=new Map;for(let _ of __){let X=new x0(_.id,_.name,_.category,{baseProductionPerSol:_.baseProductionPerSol,productionRequirement:_.productionRequirement,marketBuyPrice:_.marketBuyPrice,marketSellPrice:_.marketSellPrice});L.set(_.id,X)}class G0 extends E0{moduleType;constructor(_,X=1){super(X);this.moduleType=_}}var D0={[0]:{name:"Rocket Lab",color:"#4a90e2",icon:"rocket_launch"},[1]:{name:"Storeroom",color:"#60c531",icon:"package_2"}};class V0 extends G0{infrastructureId;constructor(_,X=1){super("infrastructure",X);this.infrastructureId=_,this.MAX_LEVEL=P.infrastructure.maxLevel}getWorkersNeeded(_){let X=_??this.getLevel();return Math.ceil(X/P.infrastructure.rocketLab.workersPerLevelDivisor)*P.infrastructure.rocketLab.workersPerLevelMultiplier+P.infrastructure.rocketLab.workersBase}getModuleIdentifier(){return this.infrastructureId}getModuleName(){return D0[this.infrastructureId]?.name||"Infrastructure"}getColor(){return D0[this.infrastructureId]?.color||"#888888"}getIcon(){return D0[this.infrastructureId]?.icon||"build"}getBenefitValue(_){let X=_??this.getLevel();switch(this.infrastructureId){case 0:return Math.floor(X/P.infrastructure.rocketLab.benefitLevelDivisor)+P.infrastructure.rocketLab.benefitBaseValue;case 1:return P.infrastructure.storeroom.baseCapacity*Math.pow(P.infrastructure.storeroom.capacityScalingFactor,(_??this.getLevel())-1);default:return 0}}onUpgrade(){return}getProperties(){let _=this.getBenefitValue(),X=this.getBenefitValue(this.getLevel()+1),$="Benefit";switch(this.infrastructureId){case 0:$="Rockets Allowed";break;case 1:$="Storage Capacity";break}return[{name:$,value:_,increase:X-_},{name:"Workers Needed",value:this.getWorkersNeeded(),increase:this.getWorkersNeeded(this.getLevel()+1)-this.getWorkersNeeded()}]}toData(){return{infrastructureId:this.infrastructureId,level:this.getLevel()}}}class t extends G0{goodId;initialQuantityPerSol;constructor(_,X=1){super("production",X);this.goodId=_,this.initialQuantityPerSol=L.get(_)?.baseProductionPerSol??1}getWorkersNeeded(_){return Math.ceil(this.getQuantityPerSol(_)/P.production.workersPerProductionUnitDivisor)}getModuleIdentifier(){return this.goodId}getModuleName(){let _=L.get(this.goodId);return _?_.name:`Good #${this.goodId}`}getQuantityPerSol(_){return this.initialQuantityPerSol*Math.pow(1.2,(_??this.getLevel())-1)}onUpgrade(){return}getProperties(){return[{name:"Production (t/sol)",value:this.getQuantityPerSol(),increase:this.getQuantityPerSol(this.getLevel()+1)-this.getQuantityPerSol()},{name:"Workers Needed",value:this.getWorkersNeeded(),increase:this.getWorkersNeeded(this.getLevel()+1)-this.getWorkersNeeded()}]}toData(){return{goodId:this.goodId,level:this.getLevel()}}}class e extends Q0{colonyId;name;locationId;colonyModules=[];constructor(_,X,$,j=1,Y=[]){super([],100,j);this.colonyId=_,this.name=X,this.locationId=$,this.colonyModules=Y,this.scaleFactor=1.175,this.MAX_LEVEL=1499}onUpgrade(){return}getProductionMultiplier(){return a(this.locationId.getType())*a(this.locationId.getType())*Math.pow(1.02,this.getLevel()-1)}getCapacity(_){let X=super.getCapacity(_),$=this.getInfrastructureModules().filter((j)=>j.infrastructureId===1).reduce((j,Y)=>j+Y.getBenefitValue(),0);return a(this.locationId.getType())*a(this.locationId.getType())*Math.floor(X+$)}addColonyModule(_){if(this.colonyModules.length>=this.getCompanyModulesAllowed())return!1;return this.colonyModules.push(_),!0}removeColonyModule(_){this.colonyModules=this.colonyModules.filter((X)=>X!==_)}getCompanyModulesAllowed(_){let X=_??this.getLevel();if(X>=999)return 15;if(X>=200)return 12;if(X>=50)return 9;if(X>=10)return 6;return 3}getColonyModules(){return this.colonyModules}getProductionModules(){return this.colonyModules.filter((_)=>_ instanceof t)}getInfrastructureModules(){return this.colonyModules.filter((_)=>_ instanceof V0)}getTotalProductionPerSol(){let _=this.getProductionMultiplier(),X=new Map;this.getProductionModules().forEach((Y)=>{let J=Y.getQuantityPerSol()*_;if(X.has(Y.goodId))X.set(Y.goodId,X.get(Y.goodId)+J);else X.set(Y.goodId,J)});let j=[];return X.forEach((Y,J)=>{j.push({goodId:J,quantity:Y})}),j}getProperties(){return[{name:"Storage Capacity",value:this.getCapacity(),increase:this.getCapacity(this.getLevel()+1)-this.getCapacity()},{name:"Production Multiplier",value:parseFloat(this.getProductionMultiplier().toFixed(2)),increase:parseFloat((this.getProductionMultiplier()*1.02-this.getProductionMultiplier()).toFixed(2))},{name:"Colony Modules",value:this.getCompanyModulesAllowed(),increase:this.getCompanyModulesAllowed(this.getLevel()+1)-this.getCompanyModulesAllowed()}]}toData(){return{colonyId:this.colonyId,name:this.name,location:this.locationId.toData(),colonyModules:this.colonyModules.map((_)=>({type:_.moduleType,..._.toData()})),storage:{items:this.getItemPositions().map((_)=>_.toData()),level:this.getLevel()}}}static fromData(_,X){let $=d.fromData(_.location),j=new e(_.colonyId,_.name,$,_.storage?.level??1,[]),Y=(_.storage?.items??[]).map((K)=>f.fromData(K,X));j.setItems(Y);let J=_.colonyModules??[];return j.colonyModules=J.map((K)=>{if(K.type==="infrastructure")return new V0(K.infrastructureId,K.level??1);else return new t(K.goodId,K.level??1)}),j}tick(_){}endOfSolUpdate(){this.getTotalProductionPerSol().forEach((_)=>{let X=_.quantity;if(X>0){let $=L.get(_.goodId);if($){if(!this.addItemPosition(new f($,X))){let Y=this.getCapacity()-this.getTotalQuantity();this.addItemPosition(new f($,Y)),console.log(`Colony ${this.name} produced ${X} of ${$.name}, but storage is full! Excess goods are lost.`)}}}})}}class z0 extends E0{id;name;credits;colonies;constructor(_,X){super(1);this.id=_,this.name=X,this.credits=5000,this.colonies=[]}onUpgrade(){}getMoney(){return this.credits}setMoney(_){this.credits=_}addMoney(_){this.credits+=_}deductMoney(_){if(this.credits>=_)return this.credits-=_,!0;return!1}addColony(_){this.colonies.push(_)}toData(){return{id:this.id,name:this.name,credits:this.credits,level:this.getLevel(),colonies:this.colonies.map((_)=>_.toData())}}getProperties(){return[]}static fromData(_,X){let $=new z0(_.id,_.name);return $.credits=_.credits??$.credits,$.setLevel(_.level??1),$.colonies=(_.colonies??[]).map((j)=>e.fromData(j,X)),$}}class o{sessionId;playerName;company;rockets;totalSolsPassed=0;currentSol=1;currentSolProgress=0;tutorialActive=!1;tutorialStep=0;tutorialCompleted=!1;explorationMissions=[];constructor(_,X,$){this.sessionId=_,this.playerName=X,this.company=$,this.rockets=[]}addRocket(_){this.rockets.push(_)}updateSolProgress(_){this.currentSolProgress=_}incrementSol(){this.totalSolsPassed++,this.currentSol++,this.currentSolProgress=0}getSolData(){return{currentSol:this.currentSol,currentSolProgress:this.currentSolProgress}}toData(){return{sessionId:this.sessionId,playerName:this.playerName,company:this.company.toData(),rockets:this.rockets.map((_)=>_.toData()),totalSolsPassed:this.totalSolsPassed,currentSol:this.currentSol,currentSolProgress:this.currentSolProgress,tutorialActive:this.tutorialActive,tutorialStep:this.tutorialStep,tutorialCompleted:this.tutorialCompleted,explorationMissions:this.explorationMissions}}static fromData(_){let X=z0.fromData(_.company,L),$=new o(_.sessionId,_.playerName,X),j=new Map;return X.colonies.forEach((Y)=>j.set(Y.locationId.getId(),Y.locationId)),$.rockets=(_.rockets??[]).map((Y)=>r.fromData(Y,j,L)),$.totalSolsPassed=_.totalSolsPassed??0,$.currentSol=_.currentSol??1,$.currentSolProgress=_.currentSolProgress??0,$.tutorialActive=_.tutorialActive??!1,$.tutorialStep=_.tutorialStep??0,$.tutorialCompleted=_.tutorialCompleted??!1,$.explorationMissions=(_.explorationMissions??[]).map((Y)=>({rocketId:String(Y.rocketId),targetType:Y.targetType})),$}}function M(_,X){let $=document.createElement(_);if(!X)return $;if(X.classes)$.classList.add(...X.classes);if(X.id)$.id=X.id;if(X.textContent)$.textContent=X.textContent;if(X.innerHTML)$.innerHTML=X.innerHTML;if(X.attributes)Object.entries(X.attributes).forEach(([j,Y])=>{$.setAttribute(j,Y)});if(X.styles)Object.assign($.style,X.styles);if(X.dataset)Object.entries(X.dataset).forEach(([j,Y])=>{$.dataset[j]=Y});if(X.children)X.children.forEach((j)=>$.appendChild(j));if(X.onClick)$.addEventListener("click",X.onClick);if(X.onInput)$.addEventListener("input",X.onInput);return $}function E(_){return M("div",_)}function G(_){return M("button",_)}function D(_){return M("span",_)}function V(_){return M("p",_)}function S(_,X){return M(`h${_}`,X)}function l(_){return M("section",_)}function b0(_){return M("table",_)}function X_(_){return M("tr",_)}function h0(_){return M("td",_)}function m(_,X){let $={...X,classes:["material-symbols-rounded",...X?.classes||[]],textContent:_};return D($)}function $_(_,X,$){let j=m(_);return G({classes:["btn","btn-icon",...$||[]],children:[j],onClick:X})}function F0(_,X,$="sell",j,Y=!1){let J=m($),K=E({classes:["upgrade-cost"],children:[D({classes:["upgrade-cost-label"],textContent:_}),D({classes:["upgrade-cost-amount"],textContent:`${F(X)}`})]}),Z=G({classes:["btn","btn-upgrade"],children:[J,K],onClick:j&&!Y?j:void 0});if(j&&Y){let W=null,v=null,z=!1,O=!1,U=()=>{z=!1,O=!0,W=window.setTimeout(()=>{z=!0,j(new MouseEvent("click")),v=window.setInterval(()=>{if(Z.disabled)A();else j(new MouseEvent("click"))},100)},500)},A=()=>{if(W)clearTimeout(W),W=null;if(v)clearInterval(v),v=null;z=!1,O=!1},H=(q)=>{if(O)A()};Z.addEventListener("click",(q)=>{if(!z)j(q)}),Z.addEventListener("mousedown",(q)=>{U()}),Z.addEventListener("mouseup",A),Z.addEventListener("mouseleave",A),window.addEventListener("mouseup",H),Z.addEventListener("touchstart",(q)=>{q.preventDefault(),U()}),Z.addEventListener("touchend",A),Z.addEventListener("touchcancel",A)}return Z}function N(_,X=document){return X.querySelector(_)}function c(_,X=document){return Array.from(X.querySelectorAll(_))}function _0(_,...X){_.classList.add(...X)}function H0(_,...X){_.classList.remove(...X)}function j_(_,X){return _.classList.contains(X)}function T(_){while(_.firstChild)_.removeChild(_.firstChild)}function W0(_,X){_.textContent=X}function L0(_){H0(_,"hidden")}function w0(_){_0(_,"hidden")}function A0(_){return!j_(_,"hidden")}function F(_){let X=["","K","M","B","T"];if(_<1000)return`${_.toFixed(0)}$`;let $=0,j=_;while(j>=1000&&$<X.length)j/=1000,$++;if($<X.length)return`${j.toFixed(1)}${X[$]}$`;while(j>=1000)j/=1000,$++;let Y=$-X.length,J=C0(Y);return`${j.toFixed(1)}${J}$`}function C0(_){if(_<676){let K=Math.floor(_/26),Z=_%26;return String.fromCharCode(97+K)+String.fromCharCode(97+Z)}let X=_-676,$=3,j=Math.pow(26,3),Y=X;while(Y>=j)Y-=j,$++,j=Math.pow(26,$);let J=[];for(let K=$-1;K>=0;K--){let Z=Math.pow(26,K),W=Math.floor(Y/Z);J.push(String.fromCharCode(97+W)),Y%=Z}return J.join("")}function h(_,X=!1){let $=["","K","M","B","T"];if(_=X?Math.floor(_):_,_<1000)if(_>=10)return _.toFixed(0);else if(_>=1)return _.toFixed(1);else return _.toFixed(2);let j=0,Y=_;while(Y>=1000&&j<$.length)Y/=1000,j++;let J=Y>=10?0:1;if(j<$.length)return`${Y.toFixed(J)}${$[j]}`;while(Y>=1000)Y/=1000,j++;let K=j-$.length,Z=C0(K),W=Y>=10?0:1;return`${Y.toFixed(W)}${Z}`}function k0(_,X=!1){return E({classes:["lvl-view-card"],children:[D({classes:["lvl-label"],textContent:"Level"}),D({classes:["lvl-number"],textContent:X?"MAX":_.toString()})]})}function p0(_,X,$){let j=[h0({textContent:_})];if($!==void 0&&$!==0){let Y=D({textContent:`${typeof X==="number"?h(X):X} `}),J=D({classes:["lvl-upgrade-modifier"],textContent:`+${typeof $==="number"?h($):$}`}),K=h0({children:[Y,J]});j.push(K)}else j.push(h0({textContent:typeof X==="number"?h(X):X}));return X_({children:j})}function X0(_,X){let $=$_("close",X);return E({classes:["view-hotbar"],children:[D({classes:["view-hotbar-title"],textContent:_}),$]})}function $0(_,X=!1){let $=["view-content"];if(X)$.push("column");return E({classes:$,children:_})}function j0(_,X){return E({classes:["row",...X||[]],children:_})}class g0{modals;onUpgradeCallbacks;onBuildModuleCallback=null;onBuildRocketCallback=null;onStartExplorationCallback=null;onStartTravelCallback=null;overlay;goodsRegistry=null;modalData=new Map;constructor(){this.modals=new Map,this.onUpgradeCallbacks=new Map,this.overlay=null,this.initializeModals()}setGoodsRegistry(_){this.goodsRegistry=_}updateModalWithStoredData(_){let X=this.modalData.get(_);if(X)if(this.modals.has(_)&&this.isOpen(_))this.update(_,X);else this.open(_,X)}initializeModals(){if(console.log("[ModalManager] Initializing modals"),this.overlay=N(".modal-overlay"),this.overlay)this.overlay.onclick=()=>this.closeTopModal();let _=N(".notification-view"),X=N(".settings-view");if(_)this.modals.set("notification-view",_),this.setupCloseButton(_,"notification-view");if(X)this.modals.set("settings-view",X),this.setupCloseButton(X,"settings-view")}setupCloseButton(_,X){let $=N(".view-hotbar .btn-icon",_);if($)$.onclick=()=>this.close(X)}open(_,X){if(console.log("[ModalManager] Opening modal:",_,"data:",X),_==="module-view"){let j=this.modals.get(_);if(j)console.log("[ModalManager] Removing existing module modal"),j.remove(),this.modals.delete(_),this.modalData.delete(_)}let $=this.modals.get(_);if(!$){let j=this.createDynamicModal(_,X);if(j)$=j,this.modals.set(_,$),document.body.appendChild($),console.log("[ModalManager] Created and appended new modal");else console.warn("[ModalManager] Failed to create modal")}else if(X)this.update(_,X);if(X)this.modalData.set(_,X);if($){if(L0($),this.overlay)L0(this.overlay),this.updateOverlayZIndex(),console.log("[ModalManager] Modal and overlay shown")}}close(_){let X=this.modals.get(_);if(X){if(w0(X),_==="module-view")X.remove(),this.modals.delete(_);this.updateOverlayVisibility(),this.updateOverlayZIndex()}}closeAll(){if(this.modals.forEach((_)=>{w0(_)}),this.overlay)w0(this.overlay)}closeTopModal(){let _=null,X=-1;if(this.modals.forEach(($,j)=>{if(A0($)){let Y=window.getComputedStyle($),J=parseInt(Y.zIndex,10);if(!isNaN(J)&&J>X)X=J,_=j}}),_)this.close(_)}updateOverlayVisibility(){let _=!1;if(this.modals.forEach((X)=>{if(A0(X))_=!0}),!_&&this.overlay)w0(this.overlay)}updateOverlayZIndex(){if(!this.overlay)return;let _=999;this.modals.forEach((X)=>{if(A0(X)){let $=window.getComputedStyle(X),j=parseInt($.zIndex,10);if(!isNaN(j)&&j>_)_=j}}),this.overlay.style.zIndex=String(_-1)}isOpen(_){let X=this.modals.get(_);return X?A0(X):!1}settingsActionCallback=null;onSettingsAction(_){this.settingsActionCallback=_}onBuildModule(_){this.onBuildModuleCallback=_}onBuildRocket(_){this.onBuildRocketCallback=_}onStartExploration(_){this.onStartExplorationCallback=_}onStartTravel(_){this.onStartTravelCallback=_}updateOpenModalsIncremental(_){if(this.isOpen("rocket-view")){let X=this.modalData.get("rocket-view");if(X)this.update("rocket-view",X)}}update(_,X){let $=this.modals.get(_);if(!$)return;switch(_){case"rocket-view":this.updateRocketModal($,X);break;case"colony-view":this.updateColonyModal($,X);break;case"notification-view":this.updateNotificationModal($,X);break;case"cargo-load-view":this.updateCargoLoadModal($,X);break;case"rocket-fleet-view":this.updateRocketFleetModal($,X);break;case"module-view":this.updateModuleModal($,X);break;case"build-module-view":this.updateBuildModuleModal($,X);break;case"settings-view":this.updateSettingsModal($,X);break;case"tutorial-view":this.updateTutorialModal($,X);break;case"exploration-view":this.updateExplorationModal($,X);break;case"travel-view":this.updateTravelModal($,X);break}}createDynamicModal(_,X){switch(_){case"rocket-fleet-view":return this.createRocketFleetModal(X);case"rocket-view":return this.createRocketModal(X);case"colony-view":return this.createColonyModal(X);case"cargo-load-view":return this.createCargoLoadModal(X);case"module-view":return this.createModuleModal(X);case"build-module-view":return this.createBuildModuleModal(X);case"tutorial-view":return this.createTutorialModal(X);case"exploration-view":return this.createExplorationModal(X);case"travel-view":return this.createTravelModal(X);default:return null}}createExplorationModal(_){let X=l({classes:["exploration-view","modal"]}),$=X0("Exploration",()=>this.close("exploration-view")),j=$0([],!0),Y=E({classes:["modal-actions"]});return X.appendChild($),X.appendChild(j),X.appendChild(Y),this.setupCloseButton(X,"exploration-view"),this.updateExplorationModal(X,_),X}updateExplorationModal(_,X){let $=N(".view-content",_);if(!$)return;T($);let{rocket:j,session:Y}=X,J=j.getLocation().getType(),K=new Set(Y.company.colonies.map((x)=>x.locationId.getType())),Z=Object.values(n).filter((x)=>x!=="Traveling").filter((x)=>x!==J).filter((x)=>!K.has(x)).filter((x)=>g.some((p)=>p.from===J&&p.to===x));if($.appendChild(V({textContent:`Rocket: ${j.name} (from ${j.getLocation().name})`,classes:["text-secondary"]})),j.getDestination()){$.appendChild(V({textContent:"This rocket is currently traveling.",classes:["text-muted"]}));return}if(Z.length===0){$.appendChild(V({textContent:"No valid exploration targets available from this location.",classes:["text-muted"]}));return}let W=X.selectedTargetType&&Z.some((x)=>x===X.selectedTargetType)?X.selectedTargetType:Z[0];X.selectedTargetType=W;let v=E({classes:["row"],styles:{gap:"8px",alignItems:"center",marginBottom:"16px"}});v.appendChild(D({textContent:"Target:",classes:["text-secondary"]}));let z=document.createElement("select");z.classList.add("btn","btn-secondary"),z.id="exploration-target-select",Z.forEach((x)=>{let p=document.createElement("option");if(p.value=x,p.textContent=x,x===W)p.selected=!0;z.appendChild(p)}),z.onchange=()=>{X.selectedTargetType=z.value,this.update("exploration-view",X)},v.appendChild(z),$.appendChild(v);let O=g.find((x)=>x.from===J&&x.to===W);if(!O){$.appendChild(V({textContent:"No route available.",classes:["text-muted"]}));return}let U=Y.company.colonies.length,A=Math.max(0,U-1),H=Math.floor(1e5*Math.pow(4,A)),q=O.fuelCost*2,Q=O.travelTime*2,I=E({classes:["lvl-table-wrap"]}),B=b0({classes:["lvl-table"],children:[j0([D({textContent:"Unlock time",classes:["lvl-property-name"]}),D({textContent:`${Q} sol`,classes:["lvl-property-value"]})]),j0([D({textContent:"Fuel required",classes:["lvl-property-name"]}),D({textContent:h(q),classes:["lvl-property-value"]})]),j0([D({textContent:"Exploration price",classes:["lvl-property-name"]}),D({textContent:F(H),classes:["lvl-property-value"]})])]});I.appendChild(B),$.appendChild(I);let C=Y.company.colonies.find((x)=>x.locationId.getId()===j.getLocation().getId());if(C){let x=C.getItemPositions().find((i)=>i.good.getId()===3),p=x?x.quantity:0,u=Math.max(0,q-p);if(u>0){let i=L.get(3),J0=u*i.marketBuyPrice,O0=Y.company.getMoney()>=J0,K0=C.getCapacity()-C.getTotalQuantity(),B0=K0>=u,s=O0&&B0,P0=E({classes:["row"],styles:{gap:"8px",marginTop:"12px",alignItems:"center",flexWrap:"wrap"}}),o0=D({textContent:`Need ${h(u)} more Fuel`,classes:["text-secondary"]});P0.appendChild(o0);let Z0=G({classes:["btn","btn-small"],textContent:`Buy Fuel (${F(J0)})`,onClick:()=>{if(s)Y.company.deductMoney(J0),C.addItemPosition(new f(i,u)),this.update("exploration-view",X)}});if(!s){if(Z0.disabled=!0,Z0.style.opacity="0.5",Z0.style.cursor="not-allowed",!O0)Z0.title="Not enough money";else if(!B0)Z0.title=`Not enough storage space (need ${u}, have ${K0})`}P0.appendChild(Z0),$.appendChild(P0)}}let k=N(".modal-actions",_);if(!k)k=E({classes:["modal-actions"]}),_.appendChild(k);T(k),k.appendChild(G({classes:["btn","btn-secondary"],textContent:"Cancel",onClick:()=>this.close("exploration-view")})),k.appendChild(G({classes:["btn","btn-small"],textContent:"Launch Exploration",onClick:()=>{if(!this.onStartExplorationCallback)return;if(this.onStartExplorationCallback(j,X.selectedTargetType))this.close("exploration-view")}}))}createTravelModal(_){let X=l({classes:["travel-view","modal"]}),$=X0("Travel",()=>this.close("travel-view")),j=$0([],!0),Y=E({classes:["modal-actions"]});return X.appendChild($),X.appendChild(j),X.appendChild(Y),this.setupCloseButton(X,"travel-view"),this.updateTravelModal(X,_),X}updateTravelModal(_,X){let $=N(".view-content",_);if(!$)return;T($);let{rocket:j,session:Y}=X,J=j.getLocation().getType(),Z=Y.company.colonies.map((B)=>B.locationId.getType()).filter((B)=>B!==J).filter((B)=>B!=="Traveling").filter((B)=>g.some((C)=>C.from===J&&C.to===B));if($.appendChild(V({textContent:`Rocket: ${j.name} (from ${j.getLocation().name})`,classes:["text-secondary"]})),j.getDestination()){$.appendChild(V({textContent:"This rocket is currently traveling.",classes:["text-muted"]}));return}if(Z.length===0){$.appendChild(V({textContent:"No valid travel destinations available. Establish more colonies to travel between them.",classes:["text-muted"]}));return}let W=X.selectedTargetType&&Z.some((B)=>B===X.selectedTargetType)?X.selectedTargetType:Z[0];X.selectedTargetType=W;let v=E({classes:["row"],styles:{gap:"8px",alignItems:"center",marginBottom:"16px"}});v.appendChild(D({textContent:"Destination:",classes:["text-secondary"]}));let z=document.createElement("select");z.classList.add("btn","btn-secondary"),z.id="travel-target-select",Z.forEach((B)=>{let C=document.createElement("option");if(C.value=B,C.textContent=B,B===W)C.selected=!0;z.appendChild(C)}),z.onchange=()=>{X.selectedTargetType=z.value,this.update("travel-view",X)},v.appendChild(z),$.appendChild(v);let O=g.find((B)=>B.from===J&&B.to===W);if(!O){$.appendChild(V({textContent:"No route available.",classes:["text-muted"]}));return}let{fuelCost:U,travelTime:A}=O,H=E({classes:["lvl-table-wrap"]}),q=b0({classes:["lvl-table"],children:[j0([D({textContent:"Travel time",classes:["lvl-property-name"]}),D({textContent:`${A} sol`,classes:["lvl-property-value"]})]),j0([D({textContent:"Fuel required",classes:["lvl-property-name"]}),D({textContent:h(U),classes:["lvl-property-value"]})])]});H.appendChild(q),$.appendChild(H);let Q=Y.company.colonies.find((B)=>B.locationId.getId()===j.getLocation().getId());if(Q){let B=Q.getItemPositions().find((x)=>x.good.getId()===3),C=B?B.quantity:0,k=Math.max(0,U-C);if(k>0){let x=L.get(3),p=k*x.marketBuyPrice,u=Y.company.getMoney()>=p,i=Q.getCapacity()-Q.getTotalQuantity(),J0=i>=k,O0=u&&J0,K0=E({classes:["row"],styles:{gap:"8px",marginTop:"12px",alignItems:"center",flexWrap:"wrap"}}),B0=D({textContent:`Need ${h(k)} more Fuel`,classes:["text-secondary"]});K0.appendChild(B0);let s=G({classes:["btn","btn-small"],textContent:`Buy Fuel (${F(p)})`,onClick:()=>{if(O0)Y.company.deductMoney(p),Q.addItemPosition(new f(x,k)),this.update("travel-view",X)}});if(!O0){if(s.disabled=!0,s.style.opacity="0.5",s.style.cursor="not-allowed",!u)s.title="Not enough money";else if(!J0)s.title=`Not enough storage space (need ${k}, have ${i})`}K0.appendChild(s),$.appendChild(K0)}}let I=N(".modal-actions",_);if(!I)I=E({classes:["modal-actions"]}),_.appendChild(I);T(I),I.appendChild(G({classes:["btn","btn-secondary"],textContent:"Cancel",onClick:()=>this.close("travel-view")})),I.appendChild(G({classes:["btn","btn-small"],textContent:"Launch Travel",onClick:()=>{if(!this.onStartTravelCallback)return;if(this.onStartTravelCallback(j,X.selectedTargetType))this.close("travel-view")}}))}createGenericLevelSystemModal(_,X,$,j,Y){let J=l({classes:["lvl-view","modal",j]}),K=X0(_,()=>this.close(j)),Z=$0([],!0),W=E({classes:["modal-actions"]});return J.appendChild(K),J.appendChild(Z),J.appendChild(W),this.setupCloseButton(J,j),this.updateGenericLevelSystemModal(J,$,X,j,Y),J}updateGenericLevelSystemModal(_,X,$,j,Y){let J=N(".view-content",_);if(!J)return;T(J);let K=j0([V({textContent:$}),k0(X.getLevel(),X.isMaxLevel())]);J.appendChild(K);let Z=X.getProperties();if(Z.length>0){let O=E({classes:["lvl-table-wrap"]}),U=b0({classes:["lvl-table"],children:Z.map((A)=>p0(A.name,A.value,A.increase))});O.appendChild(U),J.appendChild(O)}if(Y)Y.forEach((O)=>J.appendChild(O));let W=N(".modal-actions",_);if(!W)W=E({classes:["modal-actions"]}),_.appendChild(W);T(W);let v=X.getUpgradeCost(),z=F0("Upgrade",v,"sell",()=>{console.log("[ModalManager] Upgrade button clicked for",j),this.triggerUpgrade(j,X)},!0);if(X.isMaxLevel())z.disabled=!0,_0(z,"btn-disabled");W.appendChild(z)}createRocketModal(_){return this.createGenericLevelSystemModal("Rocket","Upgrade your rocket to reach new planets and explore the universe!",_,"rocket-view",this.createRocketAdditionalContent(_))}updateRocketModal(_,X){this.updateGenericLevelSystemModal(_,X,"Upgrade your rocket to reach new planets and explore the universe!","rocket-view",this.createRocketAdditionalContent(X))}createRocketAdditionalContent(_){let X=[],$=_.getDestination();if($){let j=E({classes:["card"],styles:{marginTop:"16px"},children:[V({textContent:`Traveling to: ${$.name}`,styles:{fontWeight:"bold"}})]});if(_.initialTravelTime>0){let Y=Math.max(0,Math.min(100,(_.initialTravelTime-_.estimatedTravelTime)/_.initialTravelTime*100)),J=E({classes:["sol-progress-bar"],styles:{marginTop:"12px",marginBottom:"8px"},children:[E({classes:["sol-progress-fill"],styles:{width:`${Y}%`}})]}),K=_.estimatedTravelTime/P.game.minutesPerSol,Z=V({textContent:`${Math.round(Y)}% complete - ${K.toFixed(1)} sol remaining`,classes:["text-secondary"]});j.appendChild(J),j.appendChild(Z)}X.push(j)}else{let j=E({classes:["card"],styles:{marginTop:"16px"},children:[V({textContent:`Docked at: ${_.getLocation().name}`,classes:["text-secondary"]})]});X.push(j)}return X}createColonyModal(_){return this.createGenericLevelSystemModal(_.name,"Upgrade your colony to increase population and resource production!",_,"colony-view",this.createColonyAdditionalContent(_))}updateColonyModal(_,X){let $=N(".view-hotbar",_);if($){let j=N(".view-hotbar-title",$);if(j)W0(j,X.name)}this.updateGenericLevelSystemModal(_,X,"Upgrade your colony to increase population and resource production!","colony-view",this.createColonyAdditionalContent(X))}createColonyAdditionalContent(_){let X=[],$=_.getTotalProductionPerSol();if($.length>0){let z=S(3,{textContent:"Total Production per Sol"});X.push(z);let O=E({classes:["production-list"]});$.forEach(({goodId:U,quantity:A})=>{let H=this.goodsRegistry?.get(U),q=H?H.name:`Good #${U}`,Q=E({classes:["production-item"],children:[D({textContent:q,classes:["production-good-name"]}),D({textContent:`${h(A)} t/sol`,classes:["production-amount"]})]});O.appendChild(Q)}),X.push(O)}let j=_.getInfrastructureModules();if(j.length>0){let z=S(3,{textContent:"Infrastructure Modules"});X.push(z);let O=E({classes:["module-grid","infrastructure-grid"]});j.forEach((U)=>{let A=this.createInfrastructureModuleCard(U,_);O.appendChild(A)}),X.push(O)}let Y=S(3,{textContent:"Production Modules"});X.push(Y);let J=_.getProductionModules(),K=_.getCompanyModulesAllowed(),Z=[];J.forEach((z)=>{let O=this.goodsRegistry?.get(z.goodId),U=O?O.name:`Good #${z.goodId}`,A=this.createProductionModuleCard(z,U,_);Z.push(A)});let W=_.getColonyModules().length;for(let z=W;z<K;z++){let O=E({classes:["module-card","empty","clickable"],children:[D({classes:["module-icon","material-symbols-rounded"],textContent:"add"})]});O.onclick=()=>{this.open("build-module-view",{colony:_})},Z.push(O)}let v=E({classes:["module-grid"],children:Z});return X.push(v),X}createProductionModuleCard(_,X,$){let j=E({classes:["module-card","filled","clickable"],children:[D({classes:["module-icon","material-symbols-rounded"],textContent:"factory"}),D({classes:["module-label"],textContent:X}),D({classes:["module-level"],textContent:`Lv ${_.getLevel()}`})]});return console.log("[ModalManager] Card generated for production module:",{goodName:X,level:_.getLevel()}),j.onclick=()=>{console.log("[ModalManager] Production module card clicked"),this.open("module-view",{module:_,colony:$,modalType:"module-view"})},j}createInfrastructureModuleCard(_,X){let $=E({classes:["module-card","filled","clickable","infrastructure"],children:[D({classes:["module-icon","material-symbols-rounded"],textContent:_.getIcon()}),D({classes:["module-label"],textContent:_.getModuleName()}),D({classes:["module-level"],textContent:`Lv ${_.getLevel()}`})],styles:{borderColor:_.getColor(),boxShadow:`0 0 10px ${_.getColor()}40`}});return $.onclick=()=>{console.log("[ModalManager] Infrastructure module card clicked"),this.open("module-view",{module:_,colony:X,modalType:"module-view"})},$}updateNotificationModal(_,X){let $=N(".view-content",_);if(!$)return;T($),$.appendChild(V({textContent:X.message}));let j=N(".modal-actions",_);if(!j)j=E({classes:["modal-actions"]}),_.appendChild(j);T(j);let Y=G({classes:["btn","btn-secondary"],textContent:"Done",onClick:()=>{X.onConfirm?.(),this.close("notification-view")}});j.appendChild(Y)}triggerUpgrade(_,X){console.log("[ModalManager] triggerUpgrade called for",_,"entity:",X);let $=this.onUpgradeCallbacks.get(_);if(console.log("[ModalManager] Found callbacks:",$?$.length:0),$)$.forEach((j)=>j(X));else console.warn("[ModalManager] No upgrade callbacks registered for",_)}onUpgrade(_,X){if(console.log("[ModalManager] Registering upgrade callback for",_),!this.onUpgradeCallbacks.has(_))this.onUpgradeCallbacks.set(_,[]);this.onUpgradeCallbacks.get(_)?.push(X)}showNotification(_,X){this.open("notification-view",{message:_,onConfirm:X})}showSettings(){this.open("settings-view",{})}createCargoLoadModal(_){let X=l({classes:["cargo-load-view","modal"]}),$=X0("Cargo Operations",()=>this.close("cargo-load-view")),j=$0([],!0),Y=E({classes:["modal-actions"]});return X.appendChild($),X.appendChild(j),X.appendChild(Y),this.setupCloseButton(X,"cargo-load-view"),this.updateCargoLoadModal(X,_),X}updateCargoLoadModal(_,X){let $=N(".view-content",_);if(!$)return;T($);let{rocket:j,source:Y,onTransfer:J}=X,K=E({classes:["cargo-header"],children:[V({textContent:`Location: ${Y.name}`}),V({textContent:`Rocket: ${j.name}`,classes:["text-secondary"]}),V({textContent:`Rocket Storage: ${h(j.getTotalQuantity(),!0)}/${h(j.getCapacity())}`,classes:["text-secondary"]})]});$.appendChild(K);let Z=new Map;if(Y.getItemPositions().forEach((z)=>{Z.set(z.good.getId(),{good:z.good,sourceQty:z.quantity,rocketQty:0})}),j.getItemPositions().forEach((z)=>{let O=Z.get(z.good.getId());if(O)O.rocketQty=z.quantity;else Z.set(z.good.getId(),{good:z.good,sourceQty:0,rocketQty:z.quantity})}),Z.size===0)$.appendChild(V({textContent:"No goods to transfer.",classes:["text-muted"]}));else{let z=S(3,{textContent:"Cargo"});$.appendChild(z);let O=E({classes:["cargo-goods-list"]});Z.forEach(({good:U,sourceQty:A,rocketQty:H})=>{let q=this.createMergedCargoCard(U,A,H,j,Y,J);O.appendChild(q)}),$.appendChild(O)}let W=N(".modal-actions",_);if(!W)W=E({classes:["modal-actions"]}),_.appendChild(W);T(W);let v=G({classes:["btn","btn-secondary"],textContent:"Done",onClick:()=>this.close("cargo-load-view")});W.appendChild(v)}createMergedCargoCard(_,X,$,j,Y,J){let K=E({classes:["cargo-good-card","cargo-merged"],children:[E({classes:["cargo-good-info"],children:[S(4,{textContent:_.name}),E({classes:["cargo-quantities"],children:[V({textContent:`Location: ${h(X,!0)}`,classes:["text-secondary"]}),V({textContent:`Rocket: ${h($,!0)}`,classes:["text-secondary"]})]})]})]}),Z=E({classes:["cargo-controls-merged"]});if($>0){let W=E({classes:["cargo-control-section"]});[1,10,50].forEach((z)=>{if(z<=$){let O=G({classes:["btn","btn-small","btn-unload"],textContent:`-${z}`,onClick:()=>{let U=Math.min(z,$),A=Y.getCapacity()-Y.getTotalQuantity(),H=Math.min(U,A);if(H>0){if(Y.addItemPosition(new f(_,H))&&j.reduceItemQuantity(_.getId(),H))this.update("cargo-load-view",{rocket:j,source:Y,onTransfer:J}),J?.()}}});W.appendChild(O)}}),Z.appendChild(W)}if(X>0){let W=E({classes:["cargo-control-section"]});[1,10,50].forEach((z)=>{if(z<=X){let O=G({classes:["btn","btn-small"],textContent:`+${z}`,onClick:()=>{let U=Math.min(z,X),A=j.getCapacity()-j.getTotalQuantity(),H=Math.min(U,A);if(H>0){if(j.addItemPosition(new f(_,H))&&Y.reduceItemQuantity(_.getId(),H))this.update("cargo-load-view",{rocket:j,source:Y,onTransfer:J}),J?.()}}});W.appendChild(O)}}),Z.appendChild(W)}return K.appendChild(Z),K}createModuleModal(_){let{module:X,modalType:$}=_;return console.log("[ModalManager] Creating module modal:",{moduleName:X.getModuleName(),modalType:$}),this.createGenericLevelSystemModal(X.getModuleName(),"Upgrade this module to improve its capabilities.",X,$)}updateModuleModal(_,X){let{module:$,colony:j,modalType:Y}=X,J=N(".view-hotbar",_);if(J){let K=N(".view-hotbar-title",J);if(K)W0(K,$.getModuleName())}if(this.updateGenericLevelSystemModal(_,$,"Upgrade this module to improve its capabilities.",Y),this.isOpen("colony-view"))this.update("colony-view",j)}createBuildModuleModal(_){let X=l({classes:["build-module-view","modal"]}),$=X0("Build Module",()=>this.close("build-module-view")),j=$0([],!0);return X.appendChild($),X.appendChild(j),this.setupCloseButton(X,"build-module-view"),this.updateBuildModuleModal(X,_),X}updateBuildModuleModal(_,X){let{colony:$}=X,j=N(".view-content",_);if(!j)return;T(j);let Y=$.getColonyModules(),J=$.getCompanyModulesAllowed();if(Y.length>=J){j.appendChild(V({textContent:"No available module slots. Upgrade the colony to add more.",classes:["text-muted"]}));return}let K=50*Math.pow(5,Y.length),Z=S(2,{textContent:"Infrastructure Modules"});j.appendChild(Z);let W=V({textContent:"Infrastructure modules provide various benefits to your colony such as storage and rocket capacity.",classes:["text-secondary"]});j.appendChild(W);let v=E({classes:["goods-selection-grid","infrastructure-selection-grid"]});Object.entries(D0).forEach(([A,H])=>{let q=K*5,Q=E({classes:["good-selection-card","clickable","infrastructure-card"],children:[D({classes:["good-icon","material-symbols-rounded"],textContent:H.icon}),D({classes:["good-name"],textContent:H.name}),D({classes:["good-production"],textContent:`Cost: ${F(q)}`})],styles:{borderColor:H.color,boxShadow:`0 0 10px ${H.color}40`}});Q.onclick=()=>{let I=new V0(Number(A));if(this.onBuildModuleCallback){if(this.onBuildModuleCallback($,I,q)){if(this.close("build-module-view"),this.isOpen("colony-view"))this.update("colony-view",$)}}else if($.addColonyModule(I)){if(this.close("build-module-view"),this.isOpen("colony-view"))this.update("colony-view",$)}},v.appendChild(Q)}),j.appendChild(v);let z=S(2,{textContent:"Production Modules",classes:["section-title-spaced"]});j.appendChild(z);let O=V({textContent:"Production modules generate resources for your colony each sol.",classes:["text-secondary"]});if(j.appendChild(O),!this.goodsRegistry||this.goodsRegistry.size===0){j.appendChild(V({textContent:"No goods available. Make sure the goods registry is initialized.",classes:["text-muted"]}));return}let U=E({classes:["goods-selection-grid"]});this.goodsRegistry.forEach((A,H)=>{let q=K,Q=E({classes:["good-selection-card","clickable"],children:[D({classes:["good-icon","material-symbols-rounded"],textContent:A.icon||"factory"}),D({classes:["good-name"],textContent:A.name}),D({classes:["good-production"],textContent:`Cost: ${F(q)}`})],styles:{}});Q.onclick=()=>{let I=new t(H,1);if(this.onBuildModuleCallback){if(this.onBuildModuleCallback($,I,q)){if(this.close("build-module-view"),this.isOpen("colony-view"))this.update("colony-view",$)}}else if($.addColonyModule(I)){if(this.close("build-module-view"),this.isOpen("colony-view"))this.update("colony-view",$)}},U.appendChild(Q)}),j.appendChild(U)}updateSettingsModal(_,X){let $=N(".view-content",_);if(!$)return;T($);let j=M("h3",{textContent:"General"});$.appendChild(j);let Y=M("button",{classes:["btn","btn-item","btn-danger"],textContent:"New Game",onClick:()=>{if(confirm("Start a new game? Current progress will be lost."))this.settingsActionCallback?.("new-game")}});$.appendChild(Y);let J=M("h3",{textContent:"Cheats / Debug",styles:{marginTop:"20px"}});$.appendChild(J);let K=E({classes:["column"],styles:{gap:"10px",marginTop:"10px"}}),Z=M("button",{classes:["btn","btn-upgrade"],children:[M("span",{classes:["material-symbols-rounded"],textContent:"add"}),E({classes:["column"],styles:{alignItems:"flex-start"},children:[M("h3",{textContent:"Add 1M Credits"}),M("span",{textContent:"Cheat",styles:{fontSize:"0.8em",opacity:"0.7"}})]})],onClick:()=>{this.settingsActionCallback?.("cheat-money",1e6)}});K.appendChild(Z);let W=M("button",{classes:["btn","btn-upgrade"],children:[M("span",{classes:["material-symbols-rounded"],textContent:"add"}),E({classes:["column"],styles:{alignItems:"flex-start"},children:[M("h3",{textContent:"Add 10M Credits"}),M("span",{textContent:"Cheat",styles:{fontSize:"0.8em",opacity:"0.7"}})]})],onClick:()=>{this.settingsActionCallback?.("cheat-money",1e7)}});K.appendChild(W),$.appendChild(K)}createRocketFleetModal(_){let X=l({classes:["rocket-fleet-view","modal"]}),$=X0("Rocket Fleet",()=>this.close("rocket-fleet-view")),j=$0([],!0);return X.appendChild($),X.appendChild(j),this.setupCloseButton(X,"rocket-fleet-view"),this.updateRocketFleetModal(X,_),X}updateRocketFleetModal(_,X){let{colony:$,rocketCount:j}=X,Y=N(".view-content",_);if(!Y)return;T(Y);let J=$.getInfrastructureModules().find((B)=>B.infrastructureId===0);if(!J){let B=E({classes:["cargo-header"],children:[V({textContent:"Rocket Lab Required"}),V({textContent:"Build a Rocket Lab infrastructure module to unlock rocket construction.",classes:["text-secondary"]})]});Y.appendChild(B);return}let K=J.getBenefitValue(),Z=j<K,W=E({classes:["cargo-header"],children:[V({textContent:`Location: ${$.name}`}),V({textContent:`Fleet Size: ${j}/${K} Rockets`,classes:["text-secondary"]}),V({textContent:`Rocket Lab Level: ${J.getLevel()}`,classes:["text-secondary"]})]});Y.appendChild(W);let v=S(3,{textContent:"Build New Rocket"});if(Y.appendChild(v),!Z){let B=E({classes:["cargo-good-card","cargo-unload"],children:[V({textContent:"Capacity reached. Upgrade the Rocket Lab to build more rockets.",styles:{margin:"0"}})]});Y.appendChild(B)}let z=Math.pow(1.5,j),O=[{id:3,name:"Fuel",amount:Math.floor(50*z),icon:"oil_barrel"},{id:7,name:"O2",amount:Math.floor(50*z),icon:"spo2"},{id:4,name:"Computer",amount:Math.floor(10*z),icon:"memory"},{id:5,name:"Circuit Board",amount:Math.floor(20*z),icon:"memory"}],U=!0,A=$.getItemPositions(),H=V({textContent:"Required Resources:",styles:{marginBottom:"0.5rem",opacity:"0.8"}});Y.appendChild(H);let q=E({classes:["cargo-goods-list"]});O.forEach((B)=>{let C=A.find((u)=>u.good.getId()===B.id),k=C?C.quantity:0,x=k>=B.amount;if(!x)U=!1;let p=E({classes:["cargo-good-card","cargo-merged"],children:[E({classes:["cargo-good-info"],children:[E({styles:{display:"flex",alignItems:"center",gap:"0.5rem"},children:[m(B.icon,{styles:{fontSize:"20px"}}),S(4,{textContent:B.name,styles:{margin:"0"}})]})]}),E({classes:["cargo-quantities"],children:[V({textContent:`Required: ${h(B.amount)}`}),V({textContent:`Available: ${h(k)}`,classes:[x?"text-success":"text-danger"]})]})]});q.appendChild(p)}),Y.appendChild(q);let Q=N(".modal-actions",_);if(!Q)Q=E({classes:["modal-actions"]}),_.appendChild(Q);T(Q);let I=G({classes:["btn","btn-upgrade"],children:[m("rocket_launch",{}),E({classes:["column"],styles:{alignItems:"flex-start"},children:[S(3,{textContent:"Build Rocket",styles:{margin:"0"}}),D({textContent:U&&Z?"Construct new rocket":"Requirements not met",styles:{fontSize:"0.9em",opacity:"0.8"}})]})],onClick:()=>{if(this.onBuildRocketCallback){if(this.onBuildRocketCallback($))this.close("rocket-fleet-view")}}});if(!Z||!U)I.disabled=!0,I.classList.add("btn-disabled"),I.style.opacity="0.5",I.style.cursor="not-allowed";Q.appendChild(I)}createTutorialModal(_){let X=l({classes:["modal","tutorial-modal"],id:"tutorial-modal"}),$=E({classes:["tutorial-container"]});return X.appendChild($),this.updateTutorialModal(X,_),X}updateTutorialModal(_,X){let $=_.querySelector(".tutorial-container");if(!$)return;T($);let j=E({classes:["tutorial-header"],children:[S(2,{textContent:X.title}),E({classes:["tutorial-step-indicator"],textContent:X.isStart?"":`${X.step+1} / ${X.totalSteps}`})]}),Y=E({classes:["tutorial-content"],children:[V({textContent:X.text})]}),J=E({classes:["tutorial-actions"]});if(X.canSkip!==!1){let Z=G({classes:["btn","btn-secondary"],textContent:X.isStart?"Skip Tour":"End Tour",onClick:()=>{if(X.onSkip)X.onSkip()}});J.appendChild(Z)}let K=G({classes:["btn","btn-small"],textContent:X.isStart?"Start Tour":X.isEnd?"Finish":"Next",onClick:()=>{if(X.onNext)X.onNext()}});if(J.appendChild(K),$.appendChild(j),$.appendChild(Y),$.appendChild(J),document.querySelectorAll(".tutorial-highlight").forEach((Z)=>Z.classList.remove("tutorial-highlight")),X.highlightElement){let Z=document.querySelector(X.highlightElement);if(Z)Z.classList.add("tutorial-highlight"),Z.scrollIntoView({behavior:"smooth",block:"center"})}}}var b=new g0;class y0{moneyCounter;settingsButton;companyNameDisplay;solCounterDisplay;solProgressFill;constructor(){this.moneyCounter=N(".money-counter"),this.solCounterDisplay=N(".sol-counter"),this.solProgressFill=N(".sol-progress-fill"),this.companyNameDisplay=N("header h2");let _=c("header .btn-icon");if(this.settingsButton=_.find((X)=>{return N(".material-symbols-rounded",X)?.textContent?.trim()==="settings"})||null,this.settingsButton)this.settingsButton.onclick=()=>{b.showSettings()};this.initialize()}initialize(){if(!this.moneyCounter)console.warn("Money counter element not found in DOM");if(!this.companyNameDisplay)console.warn("Company name display element not found in DOM")}update(_){this.updateMoneyDisplay(_.company.getMoney()),this.updateCompanyName(_.company.name),this.updateSolDisplay(_.getSolData())}updateMoneyDisplay(_){if(this.moneyCounter){let X=F(_);W0(this.moneyCounter,X)}}updateSolDisplay(_){if(this.solCounterDisplay)this.solCounterDisplay.textContent=`Sol ${_.currentSol}`;if(this.solProgressFill)this.solProgressFill.style.width=`${Math.min(100,Math.max(0,_.currentSolProgress*100))}%`}updateCompanyName(_){if(this.companyNameDisplay)W0(this.companyNameDisplay,_)}showToast(_,X=2000){let $=N(".toast-container");if(!$)$=E({classes:["toast-container"]}),document.body.appendChild($);while($.children.length>=5)if($.firstChild)$.removeChild($.firstChild);let j=E({classes:["toast"],textContent:_});$.appendChild(j),setTimeout(()=>{_0(j,"show")},10),setTimeout(()=>{H0(j,"show"),setTimeout(()=>{j.remove()},300)},X)}showError(_){b.showNotification(`Error: ${_}`)}showSuccess(_){this.showToast(_,2000)}animateMoneyChange(_,X,$=500){if(!this.moneyCounter)return;let j=Date.now(),Y=X-_,J=()=>{let K=Date.now()-j,Z=Math.min(K/$,1),W=1-Math.pow(1-Z,3),v=_+Y*W;if(this.updateMoneyDisplay(Math.round(v)),Z<1)requestAnimationFrame(J);else this.updateMoneyDisplay(X)};J()}}var w=new y0;class v0{session;lastTickTime;lastRocketUpdateTime;saveInterval=P.game.autoSaveIntervalMs;lastSaveTime;constructor(_){this.lastTickTime=Date.now(),this.lastRocketUpdateTime=Date.now(),this.lastSaveTime=Date.now(),this.session=_??this.createNewSession("Mars Inc."),window.gameManager=this}createNewSession(_){let X=new z0("comp-1",`${_}`),$=new o("sess-1",_,X),j=new d("Earth","Earth HQ","loc-earth"),Y=new e("col-1","Earth HQ",j),J=L.get(1);if(J)Y.addColonyModule(new t(J.getId(),3));return X.addColony(Y),$}loadSession(_){let X=JSON.parse(_);this.session=o.fromData(X)}saveSession(){return JSON.stringify(this.session.toData())}setSession(_){this.session=_}tickCounter=0;lastSolPassed=0;tick(){let _=Date.now(),$=(_-this.lastTickTime)/1000/60;this.lastTickTime=_,this.tickCounter++;let j=!1;if(this.tickCounter%30===0){let J=(_-this.lastRocketUpdateTime)/1000/60;this.lastRocketUpdateTime=_,this.updateRockets(J),this.updateColonies($),j=!0}if(_-this.lastSaveTime>this.saveInterval)this.lastSaveTime=_;if(this.tickCounter%10===0){let Y=P.game.minutesPerSol*60*1000;if(this.lastSolPassed===0)this.lastSolPassed=_-this.session.currentSolProgress*Y;if(_-this.lastSolPassed>Y)this.passSol(),j=!0;else{let J=(_-this.lastSolPassed)/Y;this.session.updateSolProgress(J),j=!0}}if(this.tickCounter>=300)this.tickCounter=0;return j}passSol(){this.lastSolPassed=Date.now(),console.log("A new Sol has begun!"),this.session.incrementSol(),this.session.company.colonies.forEach((_)=>{_.endOfSolUpdate()})}updateRockets(_){let X=!1;return this.session.rockets.forEach(($)=>{if($.getDestination()){if($.estimatedTravelTime-=_,X=!0,$.estimatedTravelTime<=0){if($.completeTravel(),console.log(`Rocket ${$.name} arrived at ${$.getLocation().name}`),$.sellRoute)this.handleSellRouteAutomation($);let j=this.session.explorationMissions.findIndex((Y)=>Y.rocketId===$.getId());if(j>=0){let Y=this.session.explorationMissions[j];if(Y){if($.getLocation().getType()===Y.targetType){if(!this.session.company.colonies.some((K)=>K.locationId.getType()===Y.targetType)){let K=new e(`col-${Date.now()}`,`${$.getLocation().name} Outpost`,$.getLocation());this.session.company.addColony(K),console.log(`Exploration complete: established colony at ${$.getLocation().name}`)}}this.session.explorationMissions.splice(j,1),X=!0}}}}}),X}updateColonies(_){let X=_/P.game.minutesPerSol;if(X<0.0001)return!1;return this.session.company.colonies.forEach(($)=>{$.tick(X)}),!0}static EXPLORATION_BASE_PRICE=1e5;static EXPLORATION_PRICE_BASE=4;getExplorationTargetsForRocket(_){if(_.getDestination())return[];let X=_.getLocation().getType(),$=new Set(this.session.company.colonies.map((Y)=>Y.locationId.getType()));return $.add("Traveling"),Object.values(n).filter((Y)=>Y!==X).filter((Y)=>Y!=="Traveling").filter((Y)=>!$.has(Y)).filter((Y)=>g.some((J)=>J.from===X&&J.to===Y))}getExplorationQuote(_,X){let $=_.getLocation().getType(),j=g.find((v)=>v.from===$&&v.to===X);if(!j)return null;let Y=this.session.company.colonies.length,J=Math.max(0,Y-1),K=Math.floor(v0.EXPLORATION_BASE_PRICE*Math.pow(v0.EXPLORATION_PRICE_BASE,J)),Z=j.fuelCost*2,W=j.travelTime*P.game.minutesPerSol*2;return{priceCredits:K,fuelUnits:Z,unlockMinutes:W}}startExploration(_,X){if(_.getDestination())return{ok:!1,message:"Rocket is already traveling."};if(this.session.explorationMissions.some((W)=>W.rocketId===_.getId()))return{ok:!1,message:"Rocket is already on an exploration mission."};if(this.session.company.colonies.some((W)=>W.locationId.getType()===X))return{ok:!1,message:"Target already has a colony."};let j=this.getExplorationQuote(_,X);if(!j)return{ok:!1,message:"No valid route to target."};let Y=this.session.company.colonies.find((W)=>W.locationId.getId()===_.getLocation().getId());if(!Y)return{ok:!1,message:"Exploration must start from a colony."};let J=Y.getItemPositions().find((W)=>W.good.getId()===3);if(!J||J.quantity<j.fuelUnits)return{ok:!1,message:"Not enough Fuel."};if(!this.session.company.deductMoney(j.priceCredits))return{ok:!1,message:"Not enough money."};Y.reduceItemQuantity(3,j.fuelUnits);let K=this.getGlobalLocation(X);if(!_.startTravel(K))return this.session.company.addMoney(j.priceCredits),Y.addItemPosition(new f(L.get(3),j.fuelUnits)),{ok:!1,message:"Failed to launch exploration."};return _.estimatedTravelTime=j.unlockMinutes,_.initialTravelTime=j.unlockMinutes,this.session.explorationMissions.push({rocketId:_.getId(),targetType:X}),{ok:!0,quote:j}}startTravel(_,X){if(_.getDestination())return console.log("Rocket is already traveling."),!1;let $=this.session.company.colonies.find((v)=>v.locationId.getType()===X);if(!$)return console.log("Target location is not colonized."),!1;let j=this.session.company.colonies.find((v)=>v.locationId.getId()===_.getLocation().getId());if(!j)return console.log("Travel must start from a colony."),!1;let Y=_.getLocation().getType(),J=U0(Y,X);if(!J)return console.log("No valid route to target."),!1;let K=J.fuelCost,Z=j.getItemPositions().find((v)=>v.good.getId()===3);if(!Z||Z.quantity<K)return console.log("Not enough Fuel."),!1;if(j.reduceItemQuantity(3,K),!_.startTravel($.locationId))return j.addItemPosition(new f(L.get(3),K)),console.log("Failed to start travel."),!1;return console.log(`Travel started from ${_.getLocation().name} to ${$.name}`),!0}orderRocketTravel(_,X){let $,j=this.session.company.colonies.find((Y)=>Y.locationId.getType()===X);if(j)$=j.locationId;else $=this.getGlobalLocation(X);if($)if(_.startTravel($))console.log("Travel started");else console.log("Travel failed - invalid connection or busy")}establishColony(_){if(this.session.company.credits>=1000){this.session.company.credits-=1000;let X=new e(`col-${Date.now()}`,`${_.name} Outpost`,_);this.session.company.addColony(X),console.log("Colony established")}else console.log("Not enough credits")}buildRocket(_,X){if(this.session.company.credits>=500){this.session.company.credits-=500;let $=`rkt-${Date.now()}`,j=new r($,_,0,X);this.session.addRocket(j),console.log("Rocket built")}else console.log("Not enough credits")}getGlobalLocation(_){let X=this.session.company.colonies.find(($)=>$.locationId.getType()===_);if(X)return X.locationId;return new d(_,_,`loc-${_}`)}handleSellRouteAutomation(_){if(!_.sellRoute)return!1;let X=_.getLocation();if(_.sellRouteState==="to_earth"){if(X.getType()==="Earth")return this.executeSellAtEarth(_)}else if(_.sellRouteState==="to_origin"){let $=this.getColonyById(_.sellRouteOriginId);if($&&X.getId()===$.locationId.getId())return this.executeReloadAtOrigin(_)}else if(_.sellRouteState==="idle")return this.startSellRouteFromOrigin(_);return!1}startSellRouteFromOrigin(_){let X=this.getColonyById(_.sellRouteOriginId);if(!X)return _.sellRoute=!1,w.showToast(`${_.name}: Origin colony not found, sell route stopped`,3000),!1;this.loadAllGoods(_,X);let $=U0(X.locationId.getType(),"Earth");if(!$)return _.sellRoute=!1,w.showToast(`${_.name}: No route to Earth, sell route stopped`,3000),!1;let j=$.fuelCost,Y=X.getItemPositions().find((Z)=>Z.good.getId()===3),J=Y?Y.quantity:0;if(J<j){let Z=j-J,W=L.get(3),v=X.locationId.getType()==="Earth"?1:10,z=Z*W.marketBuyPrice*v;if(!this.session.company.deductMoney(z))return w.showToast(`${_.name}: Not enough credits to buy fuel (need ${F(z)})`,3000),!1;let O=X.getItemPositions().find((U)=>U.good.getId()===3);if(O)O.quantity+=Z;else X.getItemPositions().push(new f(W,Z))}X.reduceItemQuantity(3,j);let K=this.session.company.colonies.find((Z)=>Z.locationId.getType()==="Earth").locationId;return _.startTravel(K),_.sellRouteState="to_earth",!0}executeSellAtEarth(_){let X=this.session.company.colonies.find((v)=>v.locationId.getType()==="Earth"),$=0,j=[];_.getItemPositions().forEach((v)=>{let z=Math.floor(v.quantity),O=v.good.marketSellPrice*z;$+=O,j.push({goodId:v.good.getId(),quantity:z})}),j.forEach(({goodId:v,quantity:z})=>{_.reduceItemQuantity(v,z)}),this.session.company.addMoney($),w.showToast(`${_.name} earned ${F($)}!`,3000);let Y=this.getColonyById(_.sellRouteOriginId);if(!Y)return _.sellRoute=!1,!1;let J=U0("Earth",Y.locationId.getType());if(!J)return _.sellRoute=!1,!1;let K=J.fuelCost,Z=X.getItemPositions().find((v)=>v.good.getId()===3),W=Z?Z.quantity:0;if(W<K){let v=K-W,z=L.get(3),O=v*z.marketBuyPrice;if(!this.session.company.deductMoney(O))return w.showToast(`${_.name}: Not enough credits to buy fuel for return trip`,3000),_.sellRoute=!1,!1;let U=X.getItemPositions().find((A)=>A.good.getId()===3);if(U)U.quantity+=v;else X.getItemPositions().push(new f(z,v))}return X.reduceItemQuantity(3,K),_.startTravel(Y.locationId),_.sellRouteState="to_origin",!0}executeReloadAtOrigin(_){return _.sellRouteState="idle",this.startSellRouteFromOrigin(_)}loadAllGoods(_,X){let $=_.getCapacity()-_.getTotalQuantity(),j=0,Y=X.getItemPositions().filter((J)=>J.good.getId()!==3);for(let J of Y){if(j>=$)break;let K=Math.min(J.quantity,$-j);if(_.addItemPosition(new f(J.good,K)))X.reduceItemQuantity(J.good.getId(),K),j+=K}}getColonyById(_){if(!_)return null;return this.session.company.colonies.find((X)=>X.colonyId===_)||null}getSession(){return this.session}}function S0(){return new Promise((_,X)=>{let $=indexedDB.open("mars-inc",1);$.onerror=()=>X($.error),$.onupgradeneeded=()=>{let j=$.result;if(!j.objectStoreNames.contains("saves"))j.createObjectStore("saves",{keyPath:"slot"})},$.onsuccess=()=>_($.result)})}async function u0(_){let X=await S0();return new Promise(($,j)=>{let Y=X.transaction("saves","readwrite");Y.objectStore("saves").put(_),Y.oncomplete=()=>$(),Y.onerror=()=>j(Y.error)})}async function m0(_){let X=await S0();return new Promise(($,j)=>{let K=X.transaction("saves","readonly").objectStore("saves").get(_);K.onsuccess=()=>$(K.result??null),K.onerror=()=>j(K.error)})}async function d0(_){let X=await S0();return new Promise(($,j)=>{let Y=X.transaction("saves","readwrite");Y.objectStore("saves").delete(_),Y.oncomplete=()=>$(),Y.onerror=()=>j(Y.error)})}var s0=1,I0="default";class M0{async save(_,X=I0){let $=_.toData(),j={slot:X,payload:$,savedAt:Date.now(),version:s0};await u0(j)}async load(_=I0){let X=await m0(_);if(!X)return null;let $=this.migrate(X);return o.fromData($)}async clear(_=I0){await d0(_)}migrate(_){if(_.version===s0)return _.payload;return _.payload}}class l0{currentView="home";appContainer;navButtons;currentSession=null;constructor(){this.appContainer=N("#app")||this.createAppContainer(),this.navButtons=new Map,this.initializeNavigation()}createAppContainer(){let _=E({id:"app"});return document.body.appendChild(_),_}initializeNavigation(){let _=N("aside.row");if(!_){console.error("Navigation bar not found in DOM");return}let X=c(".btn-icon",_),$={home:"home",globe_location_pin:"locations",rocket_launch:"rockets",planet:"colonies",add_business:"buildings"};X.forEach((j)=>{let Y=N(".material-symbols-rounded",j);if(Y){let J=Y.textContent?.trim()||"",K=$[J];if(K)this.navButtons.set(K,j),j.onclick=()=>this.switchView(K)}}),this.setActiveButton(this.currentView)}setActiveButton(_){this.navButtons.forEach((X,$)=>{if($===_)_0(X,"active");else H0(X,"active")})}switchView(_){if(this.currentView===_)return;if(this.currentView=_,this.setActiveButton(_),b.closeAll(),this.currentSession)this.renderCurrentView(this.currentSession)}getCurrentView(){return this.currentView}updateView(_){this.currentSession=_,this.renderCurrentView(_)}updateViewIncremental(_){if(this.currentSession=_,this.currentView==="home")this.updateHomeViewValues(_);else if(this.currentView==="buildings")this.updateMarketValues(_);else if(this.currentView==="rockets")this.updateRocketsViewIncremental(_)}updateMarketValues(_){let X=_.company.colonies.find((J)=>J.locationId.name==="Earth HQ"||J.name==="Earth HQ");if(!X)return;c(".market-inventory-badge",this.appContainer).forEach((J)=>{let K=Number(J.dataset.goodId);if(!isNaN(K)){let Z=X.getItemPositions().find((v)=>v.good.getId()===K),W=Z?Z.quantity:0;J.textContent=h(W,!0)}}),c(".btn-sell",this.appContainer).forEach((J)=>{let K=Number(J.dataset.goodId),Z=J.dataset.sellQty,W=Number(J.dataset.sellPrice);if(!isNaN(K)&&!isNaN(W)){let v=X.getItemPositions().find((O)=>O.good.getId()===K),z=v?v.quantity:0;if(Z==="all"){let O=W*Math.floor(z),U=N(".market-btn-price",J);if(U)U.textContent=z>0?F(O):F(0);J.disabled=z<1}else{let O=Number(Z);if(!isNaN(O))J.disabled=z<O}}});let Y=N(".sell-all-button",this.appContainer);if(Y){let J=0;L.forEach((Z)=>{let W=X.getItemPositions().find((v)=>v.good.getId()===Z.getId());if(W&&W.quantity>0)J+=Math.floor(W.quantity)*Z.marketSellPrice});let K=N(".upgrade-cost-amount",Y);if(K)K.textContent=F(J);Y.disabled=J===0}}updateRocketsViewIncremental(_){let X=c(".rocket-card",this.appContainer);_.rockets.forEach(($,j)=>{let Y=X[j];if(!Y)return;let J=$.getDestination(),K=_.explorationMissions.some((z)=>z.rocketId===$.getId()),Z=N(".rocket-status",Y);if(Z)Z.textContent=J?K?`Exploring ${J.name}`:`En route to ${J.name}`:`Docked at ${$.getLocation().name}`;let W=N(".sol-progress-bar",Y),v=N(".rocket-info",Y);if(J&&$.initialTravelTime>0&&v){let z=Math.max(0,Math.min(100,($.initialTravelTime-$.estimatedTravelTime)/$.initialTravelTime*100)),O=$.estimatedTravelTime/P.game.minutesPerSol;if(W){let U=N(".sol-progress-fill",W);if(U)U.style.width=`${z}%`,U.style.backgroundColor=K?"var(--action-upgrade)":"var(--text-primary)";let A=W.nextElementSibling;if(A&&A.classList.contains("text-secondary"))A.textContent=`${Math.round(z)}% - ${O.toFixed(1)} sol remaining`}else{let U=E({classes:["sol-progress-bar"],styles:{marginTop:"8px",marginBottom:"8px"},children:[E({classes:["sol-progress-fill"],styles:{width:`${z}%`,backgroundColor:K?"var(--action-upgrade)":"var(--text-primary)"}})]}),A=$.estimatedTravelTime/P.game.minutesPerSol,H=V({textContent:`${Math.round(z)}% - ${A.toFixed(1)} sol remaining`,classes:["text-secondary"],styles:{fontSize:"12px",margin:"4px 0"}});if(Z&&Z.nextSibling)v.insertBefore(U,Z.nextSibling),v.insertBefore(H,U.nextSibling)}}else if(W){let z=W.nextElementSibling;if(W.remove(),z&&z.classList.contains("text-secondary"))z.remove()}})}updateHomeViewValues(_){let X=c(".stat-value",this.appContainer);if(X.length>=4)X[3].textContent=F(_.company.getMoney())}renderCurrentView(_){if(!_){T(this.appContainer);return}switch(this.currentView){case"home":this.renderHomeView(_);break;case"locations":this.renderLocationsView(_);break;case"rockets":this.renderRocketsView(_);break;case"colonies":this.renderColoniesView(_);break;case"buildings":this.renderBuildingsView(_);break}}renderHomeView(_){T(this.appContainer);let X=E({classes:["home-view"]}),$=this.createCompanyOverviewCard(_.company);X.appendChild($);let j=this.createQuickStatsGrid(_);X.appendChild(j);let Y=E({classes:["activity-section"],children:[S(3,{textContent:"Quick Start Guide"}),V({textContent:"Go to the Colony view (planet icon) to start upgrading your colonies!"}),V({textContent:"If you're colonies have produced goods, you now want to sell them at the World Market (store icon). "}),V({textContent:"To unlock new colonies, you must first build a Rocketry Lab (Infrastructure Module) and than produce rockets to explore new planets."})]});X.appendChild(Y),this.appContainer.appendChild(X)}createCompanyOverviewCard(_){return E({classes:["card","company-card"],children:[S(2,{textContent:_.name}),V({textContent:`Level ${_.getLevel()}`}),E({classes:["company-stats"],children:[E({children:[D({textContent:"Colonies: ",classes:["stat-label"]}),D({textContent:_.colonies.length.toString(),classes:["stat-value"]})]})]})]})}createQuickStatsGrid(_){let X=_.company;return E({classes:["stats-grid"],children:[this.createStatCard("Rockets",_.rockets.length,"rocket_launch"),this.createStatCard("Colonies",X.colonies.length,"planet"),this.createStatCard("Money",F(X.getMoney()),"sell")]})}createStatCard(_,X,$){return E({classes:["stat-card"],children:[m($,{classes:["stat-icon"]}),E({classes:["stat-content"],children:[D({textContent:_,classes:["stat-label"]}),D({textContent:X.toString(),classes:["stat-value"]})]})]})}renderLocationsView(_){T(this.appContainer);let X=E({classes:["locations-view"]});X.appendChild(S(2,{textContent:"Locations"}));let $=new Map;if(_.company.colonies.forEach((j)=>{if(!$.has(j.locationId.getId()))$.set(j.locationId.getId(),j.locationId)}),$.size===0)X.appendChild(V({textContent:"No locations discovered yet."}));else{let j=E({classes:["locations-list"]});$.forEach((Y)=>{let J=_.company.colonies.filter((U)=>U.locationId.getId()===Y.getId()),K=_.rockets.filter((U)=>U.getLocation().getId()===Y.getId()&&!U.getDestination()),Z=a(Y.getType()),W=g.filter((U)=>U.from===Y.getType()).map((U)=>{return{destination:U.to,travelTime:U.travelTime,fuelCost:U.fuelCost}}),v=E({classes:["location-card"]}),z=E({classes:["location-header"],children:[S(3,{textContent:Y.name})]}),O=E({classes:["location-info"],children:[D({textContent:`Production: ${Z}x`,classes:["location-stat"]})]});if(z.appendChild(O),v.appendChild(z),J.length>0){let U=E({classes:["location-section"]}),A=M("ul",{classes:["location-list"]}),H=E({classes:["location-section"]});H.appendChild(S(4,{textContent:"Production"}));let q=M("div",{classes:["storage-items-list"]});J.forEach((Q)=>{A.appendChild(E({classes:["colony-item"],children:[D({textContent:Q.name,classes:["storage-item-name"]}),D({textContent:`Level ${Q.getLevel()}`,classes:["storage-item-quantity"]})]})),Q.getTotalProductionPerSol().forEach((B)=>{q.appendChild(E({classes:["storage-item"],children:[D({textContent:L.get(B.goodId)?.name||"Unknown",classes:["storage-item-name"]}),D({textContent:`+${h(B.quantity)}/sol`,classes:["storage-item-quantity"]})]}))})}),U.appendChild(A),v.appendChild(U),H.appendChild(q),v.appendChild(H)}j.appendChild(v)}),X.appendChild(j)}this.appContainer.appendChild(X)}renderRocketsView(_){T(this.appContainer);let X=E({classes:["rockets-view"]});if(X.appendChild(S(2,{textContent:"Rockets"})),_.rockets.length===0)X.appendChild(V({textContent:"No rockets available. Build one to start exploring!"}));else{let $=E({classes:["rockets-list"]});[..._.rockets].sort((Y,J)=>{if(Y.sellRoute===J.sellRoute)return 0;return Y.sellRoute?1:-1}).forEach((Y)=>{let J=this.createRocketCard(Y,_);$.appendChild(J)}),X.appendChild($)}this.appContainer.appendChild(X)}createRocketCard(_,X){let $=_.getDestination(),j=X.explorationMissions.some((H)=>H.rocketId===_.getId()),Y="";if(_.sellRoute)if($)Y=_.sellRouteState==="to_earth"?"\uD83D\uDD04 Sell Route: To Earth":"\uD83D\uDD04 Sell Route: Returning";else Y=`\uD83D\uDD04 Sell Route: At ${_.getLocation().name}`;else Y=$?j?`Exploring ${$.name}`:`En route to ${$.name}`:`Docked at ${_.getLocation().name}`;let J=_.getTotalQuantity(),K=_.getCapacity(),W=!$?X.company.colonies.find((H)=>H.locationId.getId()===_.getLocation().getId()):null,v=E({classes:["rocket-actions"],styles:{display:"flex",flexDirection:"column",gap:"8px"}}),z=E({classes:["row"],styles:{gap:"8px"}});if(z.appendChild(G({classes:["btn","btn-small"],textContent:"View",onClick:()=>b.open("rocket-view",_)})),W)z.appendChild(G({classes:["btn","btn-small","btn-accent"],textContent:"Load Cargo",onClick:()=>{b.open("cargo-load-view",{rocket:_,source:W,onTransfer:()=>{this.updateView(X)}})}}));if(v.appendChild(z),W){let H=E({classes:["row"],styles:{gap:"8px"}});if(W.locationId.getType()!=="Earth")if(_.sellRoute){let q=G({classes:["btn","btn-small","btn-danger"],textContent:"Stop Sell Route",onClick:()=>{_.sellRoute=!1,_.sellRouteOriginId=null,_.sellRouteState="idle",this.updateView(X)}});H.appendChild(q)}else{let q=G({classes:["btn","btn-small","btn-accent"],textContent:"Start Sell Route",onClick:()=>{_.sellRoute=!0,_.sellRouteOriginId=W.colonyId,_.sellRouteState="idle";let Q=window.gameManager;if(Q)Q.handleSellRouteAutomation(_);this.updateView(X)}});H.appendChild(q),H.appendChild(G({classes:["btn","btn-small"],textContent:"Explore",onClick:()=>{b.open("exploration-view",{rocket:_,session:X})}}))}else H.appendChild(G({classes:["btn","btn-small"],textContent:"Explore",onClick:()=>{b.open("exploration-view",{rocket:_,session:X})}}));v.appendChild(H)}let O=[S(3,{textContent:_.name}),V({textContent:Y,classes:["rocket-status"]})];if($&&_.initialTravelTime>0){let H=Math.max(0,Math.min(100,(_.initialTravelTime-_.estimatedTravelTime)/_.initialTravelTime*100));console.log(`[Create Rocket Card] ${_.name}: progress=${H.toFixed(1)}%, initial=${_.initialTravelTime.toFixed(2)}min, remaining=${_.estimatedTravelTime.toFixed(2)}min`);let q=E({classes:["sol-progress-bar"],styles:{marginTop:"8px",marginBottom:"8px"},children:[E({classes:["sol-progress-fill"],styles:{width:`${H}%`,backgroundColor:j?"var(--action-upgrade)":"var(--text-primary)"}})]}),Q=_.estimatedTravelTime/P.game.minutesPerSol,I=V({textContent:`${Math.round(H)}% - ${Q.toFixed(1)} sol remaining`,classes:["text-secondary"],styles:{fontSize:"12px",margin:"4px 0"}});O.push(q),O.push(I)}O.push(V({textContent:`Storage: ${h(J)}/${h(_.getCapacity())}`,classes:["rocket-storage"]}),V({textContent:`Level ${_.getLevel()}`,classes:["rocket-level"]}));let U=E({classes:["rocket-card","card"],children:[m("rocket_launch",{classes:["rocket-icon"]}),E({classes:["rocket-info"],children:O,attributes:{"data-rocket-id":_.getId()}}),v]}),A=this.createStorageSection(_);return U.appendChild(A),U}renderColoniesView(_){T(this.appContainer);let X=E({classes:["colonies-view"]});if(X.appendChild(S(2,{textContent:"Colonies"})),_.company.colonies.length===0)X.appendChild(V({textContent:"No colonies established yet."}));else{let $=E({classes:["colonies-list"]});_.company.colonies.forEach((j)=>{let Y=this.createColonyCard(j,_);$.appendChild(Y)}),X.appendChild($)}this.appContainer.appendChild(X)}createColonyCard(_,X){let $=_.getItemPositions().length,j=_.getCapacity(),Y=_.getTotalQuantity(),J=E({classes:["colony-card","card"],children:[m("planet",{classes:["colony-icon"]}),E({classes:["colony-info"],children:[S(3,{textContent:_.name}),V({textContent:_.locationId.name,classes:["colony-location"]}),V({textContent:`Storage: ${h(Y)}/${h(j)}`,classes:["colony-storage"]}),V({textContent:`Level ${_.getLevel()}`,classes:["colony-level"]})]}),E({classes:["row"],styles:{gap:"8px"},children:[G({classes:["btn","btn-small"],textContent:"Manage",onClick:()=>b.open("colony-view",_)}),G({classes:["btn","btn-small","btn-accent"],textContent:"Rockets",onClick:()=>{let Z=X.rockets.filter((W)=>{return W.getLocation().getId()===_.locationId.getId()}).length;b.open("rocket-fleet-view",{colony:_,rocketCount:Z})}})]})]});console.log(`Colony ${_.name} has ${$} item types, total quantity ${Y}, capacity ${j}`);let K=this.createStorageSection(_);return J.appendChild(K),J}renderBuildingsView(_){T(this.appContainer);let X=E({classes:["buildings-view","market-view"]});X.appendChild(S(2,{textContent:"World Market (Earth)"})),X.appendChild(V({textContent:"Buy and sell goods at Earth market prices",classes:["market-description"]}));let $=_.company.colonies.find((K)=>K.locationId.name==="Earth HQ"||K.name==="Earth HQ"),j=0;if($)L.forEach((K)=>{let Z=$.getItemPositions().find((W)=>W.good.getId()===K.getId());if(Z&&Z.quantity>0)j+=Math.floor(Z.quantity)*K.marketSellPrice});let Y=F0("Sell all goods",j,"sell",()=>{this.handleSellAllGoods(_)});Y.classList.add("sell-all-button"),Y.disabled=j===0,X.appendChild(Y);let J=E({classes:["market-grid"]});L.forEach((K,Z)=>{let W=this.createMarketGoodCard(K,_);J.appendChild(W)}),X.appendChild(J),this.appContainer.appendChild(X)}createMarketGoodCard(_,X){let $=X.company.colonies.find((Z)=>Z.locationId.name==="Earth HQ"||Z.name==="Earth HQ"),j=0;if($){let Z=$.getItemPositions().find((W)=>W.good.getId()===_.getId());if(Z)j=Z.quantity}let Y={Food:"dining",Electronics:"memory",Fuel:"oil_barrel",ISRU:"factory"};if(_.name==="O2")Y.Fuel="spo2";if(_.name==="Water")Y.Food="water_drop";let J=Y[_.category]||"inventory_2";return E({classes:["market-card","card"],children:[E({classes:["market-header"],children:[m(J,{classes:["market-icon"]}),E({classes:["market-title-group"],children:[S(3,{textContent:_.name,classes:["market-good-name"]}),D({textContent:_.category,classes:["market-good-category"]})]}),E({classes:["market-inventory-badge"],textContent:h(j,!0),dataset:{goodId:String(_.getId())}})]}),E({classes:["market-prices-compact"],children:[E({classes:["price-tag","buy"],children:[D({textContent:"B:",classes:[]}),D({textContent:F(_.marketBuyPrice)})]}),E({classes:["price-tag","sell"],children:[D({textContent:"S:",classes:[]}),D({textContent:F(_.marketSellPrice)})]})]}),E({classes:["market-actions-compact"],children:[this.createCompactButton("Buy 1",F(_.marketBuyPrice),"btn-buy",()=>this.handleMarketBuy(_,_.marketBuyPrice,1,X),_),this.createCompactButton("Buy 10",F(_.marketBuyPrice*10),"btn-buy",()=>this.handleMarketBuy(_,_.marketBuyPrice,10,X),_),this.createCompactSellButton(_,_.marketSellPrice,1,"Sell 1",X),this.createCompactSellButton(_,_.marketSellPrice,-1,"Sell All",X)]})]})}createCompactButton(_,X,$,j,Y){return G({classes:["btn",$,"btn-compact"],dataset:{goodId:String(Y.getId())},children:[E({classes:["btn-compact-label"],textContent:_}),E({classes:["btn-compact-sub"],textContent:X})],onClick:j})}createCompactSellButton(_,X,$,j,Y){let J=$===-1,K="??";if(J){let v=Y.company.colonies.find((z)=>z.locationId.name==="Earth HQ"||z.name==="Earth HQ");if(v){let z=v.getItemPositions().find((U)=>U.good.getId()===_.getId()),O=z?Math.floor(z.quantity):0;K=O>0?F(X*O):F(0)}}else K=F(X*$);let Z=G({classes:["btn","btn-sell","btn-compact"],dataset:{goodId:String(_.getId()),sellQty:J?"all":String($),sellPrice:String(X)},children:[E({classes:["btn-compact-label"],textContent:j}),E({classes:["btn-compact-sub","market-btn-price"],textContent:K})],onClick:()=>{if(J){let v=Y.company.colonies.find((z)=>z.locationId.name==="Earth HQ"||z.name==="Earth HQ");if(v){let z=v.getItemPositions().find((U)=>U.good.getId()===_.getId()),O=z?Math.floor(z.quantity):0;if(O>0)this.handleMarketSell(_,X,O,Y)}}else this.handleMarketSell(_,X,$,Y)}}),W=Y.company.colonies.find((v)=>v.locationId.name==="Earth HQ"||v.name==="Earth HQ");if(W){let v=W.getItemPositions().find((O)=>O.good.getId()===_.getId()),z=v?v.quantity:0;if(J){if(z<1)Z.disabled=!0}else if(z<$)Z.disabled=!0}return Z}handleMarketBuy(_,X,$,j){let Y=X*$;if(!j.company.deductMoney(Y)){alert("Not enough money!");return}let J=j.company.colonies.find((K)=>K.locationId.name==="Earth HQ"||K.name==="Earth HQ");if(!J){j.company.addMoney(Y),alert("Earth HQ not found!");return}if(!J.addItemPosition(new f(_,$))){j.company.addMoney(Y),alert("Not enough storage space at Earth HQ!");return}w.updateMoneyDisplay(j.company.getMoney()),this.updateMarketValues(j)}handleMarketSell(_,X,$,j){let Y=j.company.colonies.find((Z)=>Z.locationId.name==="Earth HQ"||Z.name==="Earth HQ");if(!Y){alert("Earth HQ not found!");return}let J=Y.getItemPositions().find((Z)=>Z.good.getId()===_.getId());if(!J||J.quantity<$){alert("Not enough goods to sell!");return}if(!Y.reduceItemQuantity(_.getId(),$)){alert("Error selling goods!");return}if(J.quantity===0)Y.removeItemPosition(_.getId());let K=X*$;j.company.addMoney(K),w.updateMoneyDisplay(j.company.getMoney()),this.updateMarketValues(j)}handleSellAllGoods(_){let X=_.company.colonies.find((Y)=>Y.locationId.name==="Earth HQ"||Y.name==="Earth HQ");if(!X){alert("Earth HQ not found!");return}let $=0,j=[];if(L.forEach((Y)=>{let J=X.getItemPositions().find((K)=>K.good.getId()===Y.getId());if(J&&J.quantity>0){let K=Math.floor(J.quantity);j.push({good:Y,quantity:K,price:Y.marketSellPrice}),$+=K*Y.marketSellPrice}}),j.length===0){alert("No goods to sell!");return}j.forEach(({good:Y,quantity:J})=>{X.reduceItemQuantity(Y.getId(),J);let K=X.getItemPositions().find((Z)=>Z.good.getId()===Y.getId());if(K&&K.quantity===0)X.removeItemPosition(Y.getId())}),_.company.addMoney($),w.updateMoneyDisplay(_.company.getMoney()),this.updateMarketValues(_)}createWarehouseCard(_){let X=_.getTotalQuantity(),$=_.getCapacity();return E({classes:["warehouse-card","card"],children:[m("add_business",{classes:["warehouse-icon"]}),E({classes:["warehouse-info"],children:[S(3,{textContent:_.name}),V({textContent:_.locationId.name,classes:["warehouse-location"]}),V({textContent:`Storage: ${h(X)}/${h($)}`,classes:["warehouse-storage"]}),V({textContent:`Level ${_.getLevel()}`,classes:["warehouse-level"]})]})]})}createStorageSection(_){let X=_.getItemPositions(),$=E({classes:["storage-section"]});if(X.length===0)$.appendChild(V({textContent:"No items in storage",classes:["storage-empty"]}));else{let j=E({classes:["storage-items-list"]});X.forEach((Y)=>{let J=E({classes:["storage-item"],children:[D({textContent:Y.good.name,classes:["storage-item-name"]}),D({textContent:`${h(Y.quantity,!0)}`,classes:["storage-item-quantity"]})]});j.appendChild(J)}),$.appendChild(j)}return $}}var R0=new l0;class T0{gameManager;steps;constructor(_){this.gameManager=_,this.steps=new Map,this.initializeSteps()}initializeSteps(){this.steps.set(0,{step:0,title:"Welcome Commander!",description:"Welcome to Mars Inc. Your mission is to establish a self-sustaining colony on the Red Planet. Would you like a quick tour of your interface?"}),this.steps.set(1,{step:1,title:"Mission Control",description:"This is your main dashboard. From here you can oversee all your operations on Earth and Mars.",highlightElement:".header"}),this.steps.set(2,{step:2,title:"Resources",description:"Keep an eye on your resources. Credits, Fuel, and Food are vital for your expansion.",highlightElement:".resources-bar"}),this.steps.set(3,{step:3,title:"Colony Management",description:"Local colony management allows you to construct new buildings and manage production.",highlightElement:".colonies-view"}),this.steps.set(4,{step:4,title:"Production Modules",description:"Modules produce resources. Upgrade them to increase efficiency."}),this.steps.set(5,{step:5,title:"You are Ready!",description:"That concludes our tour. Use your resources wisely, expand your infrastructure, and reach for the stars. Good luck!"})}startTutorial(){if(this.gameManager.session.tutorialCompleted)return;if(!this.gameManager.session.tutorialActive)this.gameManager.session.tutorialActive=!0,this.gameManager.session.tutorialStep=0;setTimeout(()=>this.showCurrentStep(),500)}showCurrentStep(){let _=this.gameManager.session.tutorialStep,X=this.steps.get(_);if(X){if(X.onStart)X.onStart();b.open("tutorial-view",{title:X.title,text:X.description,step:_,totalSteps:this.steps.size,isStart:_===0,isEnd:_===5,highlightElement:X.highlightElement,onNext:()=>this.nextStep(),onSkip:()=>this.skipTutorial()})}else this.completeTutorial()}nextStep(){let _=this.steps.get(this.gameManager.session.tutorialStep);if(_?.onEnd)_.onEnd();if(this.gameManager.session.tutorialStep++,this.steps.has(this.gameManager.session.tutorialStep))this.showCurrentStep();else this.completeTutorial()}skipTutorial(){this.completeTutorial()}completeTutorial(){this.gameManager.session.tutorialActive=!1,this.gameManager.session.tutorialCompleted=!0,b.close("tutorial-view"),document.querySelectorAll(".tutorial-highlight").forEach((_)=>_.classList.remove("tutorial-highlight"))}}var Y0=new M0,R,c0,n0=!1,f0=0;async function K_(){try{console.log("[Mars Inc] Initializing...");let _=await Y0.load();if(_)R=new v0(_),w.showSuccess("Game loaded successfully!");else R=new v0,w.showSuccess("Welcome to Mars Inc!"),await Y0.save(R.getSession());if(b.setGoodsRegistry(L),c0=new T0(R),Z_(),y(),n0=!0,f0=Date.now(),a0(),!R.session.tutorialCompleted)c0.startTutorial();console.log("[Mars Inc] Ready")}catch(_){console.error("[Mars Inc] Initialization failed:",_),w.showError("Failed to initialize game")}}function Z_(){b.onUpgrade("rocket-view",(_)=>{let X=_.getUpgradeCost(),$=R.getSession().company;if($.deductMoney(X)){let j=$.getMoney()+X;_.incrementLevel(),w.animateMoneyChange(j,$.getMoney()),w.showSuccess("Rocket upgraded!"),b.update("rocket-view",_),y()}else w.showError("Not enough money!")}),b.onUpgrade("colony-view",(_)=>{let X=_.getUpgradeCost(),$=R.getSession().company;if($.deductMoney(X)){let j=$.getMoney()+X;_.incrementLevel(),w.animateMoneyChange(j,$.getMoney()),w.showSuccess("Colony upgraded!"),b.update("colony-view",_),y()}else w.showError("Not enough money!")}),b.onUpgrade("module-view",(_)=>{let X=_.getUpgradeCost(),$=R.getSession().company;if($.deductMoney(X)){let j=$.getMoney()+X;_.incrementLevel(),w.animateMoneyChange(j,$.getMoney()),w.showSuccess("Module upgraded!"),b.updateModalWithStoredData("module-view"),y()}else w.showError("Not enough money!")}),b.onSettingsAction((_,X)=>{if(_==="new-game")e0();else if(_==="cheat-money"){let $=Number(X),j=R.getSession().company,Y=j.getMoney();j.addMoney($),w.animateMoneyChange(Y,j.getMoney()),w.showSuccess(`Cheated ${F($)}!`),y()}}),b.onBuildModule((_,X,$)=>{let j=R.getSession().company;if(j.deductMoney($)){let Y=j.getMoney()+$;return _.addColonyModule(X),w.animateMoneyChange(Y,j.getMoney()),w.showSuccess("Module constructed!"),y(),!0}else return w.showError("Not enough credits!"),!1}),b.onBuildRocket((_)=>{let X=_.getInfrastructureModules().find((W)=>W.getModuleIdentifier()===0);if(!X)return w.showError("Rocket Lab required!"),!1;let $=R.getSession().rockets.filter((W)=>W.getLocation().getId()===_.locationId.getId()).length,j=X.getBenefitValue();if($>=j)return w.showError("Limit reached!"),!1;let Y=Math.pow(1.5,$),J=[{id:3,name:"Fuel",amount:Math.floor(50*Y)},{id:7,name:"O2",amount:Math.floor(50*Y)},{id:4,name:"Computer",amount:Math.floor(10*Y)},{id:5,name:"Circuit Board",amount:Math.floor(20*Y)}];for(let W of J){let v=_.getItemPositions().find((z)=>z.good.getId()===W.id);if(!v||v.quantity<W.amount)return w.showError(`Not enough ${W.name}!`),!1}for(let W of J)_.reduceItemQuantity(W.id,W.amount);let K=`Rocket ${R.getSession().rockets.length+1}`,Z=new r(`rkt-${Date.now()}`,K,60,_.locationId,1);return R.getSession().addRocket(Z),w.showSuccess("Rocket built!"),y(),!0}),b.onStartExploration((_,X)=>{let $=R.getSession().company,j=$.getMoney(),Y=R.startExploration(_,X);if(!Y.ok)return w.showError(Y.message??"Exploration failed"),!1;return w.animateMoneyChange(j,$.getMoney()),w.showSuccess("Exploration launched!"),y(),!0}),b.onStartTravel((_,X)=>{if(!R.startTravel(_,X))return w.showError("Travel failed"),!1;return w.showSuccess("Travel started!"),y(),!0})}function a0(){if(!n0)return;let _=Date.now(),X=(_-f0)/1000;if(f0=_,R.tick())E_();requestAnimationFrame(a0)}function y(){let _=R.getSession();w.update(_),R0.updateView(_)}function E_(){let _=R.getSession();w.updateMoneyDisplay(_.company.getMoney()),w.updateSolDisplay(_.getSolData()),R0.updateViewIncremental(_),b.updateOpenModalsIncremental(_)}var z_;function W_(){z_=window.setInterval(async()=>{try{await Y0.save(R.getSession()),console.log("Game auto-saved")}catch(_){console.error("Auto-save failed:",_)}},30000)}async function t0(){try{await Y0.save(R.getSession()),w.showSuccess("Game saved!")}catch(_){console.error("Save failed:",_),w.showError("Failed to save game")}}async function v_(){try{let _=await Y0.load();if(_)R.setSession(_),w.showSuccess("Game loaded!"),y();else w.showError("No saved game found")}catch(_){console.error("Load failed:",_),w.showError("Failed to load game")}}async function e0(){if(confirm("Start a new game? This will overwrite your current progress."))R.setSession(R.createNewSession("Mars Inc.")),await Y0.save(R.getSession()),w.showSuccess("New game started!"),y()}function O_(){document.addEventListener("keydown",(_)=>{if((_.ctrlKey||_.metaKey)&&_.key==="s")_.preventDefault(),t0();if(_.key==="Escape")b.closeAll()})}function U_(){document.addEventListener("visibilitychange",()=>{if(document.hidden)console.log("Game continues in background");else console.log("Game resumed")})}function D_(){window.addEventListener("beforeunload",async(_)=>{try{await Y0.save(R.getSession())}catch(X){console.error("Failed to save on exit:",X)}})}function V_(){window.game={addMoney:(_)=>{R.getSession().company.addMoney(_),w.showSuccess(`Added ${F(_)}`),y()},getSession:()=>R.getSession(),save:t0,load:v_,newGame:e0,showModal:(_,X)=>b.open(_,X),switchView:(_)=>R0.switchView(_)},console.log("Debug commands available: window.game")}async function i0(){console.log("Starting Mars Inc..."),O_(),U_(),D_(),V_(),await K_(),W_(),console.log("Mars Inc is ready!")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",i0);else i0();
